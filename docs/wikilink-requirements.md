# Wikilink実装要件定義書

## 1. 概要

### 1.1 目的
Astroプロジェクトにおいて、Obsidian Flavored Markdown (OFM) のWikilink記法をサポートし、内部リンクと画像埋め込みを簡潔に記述できるようにする。

### 1.2 背景
- 現在のプロジェクトはAstroベースのブログシステム
- `/src/content/blog/ofm-test/index.md` にWikilinkの使用例が存在
- 標準的なMarkdownリンク記法よりも簡潔で、Obsidianユーザーにとって親和性が高い

## 2. 機能要件

### 2.1 内部リンク機能

#### 2.1.1 基本的な内部リンク
- **記法**: `[[path/to/file.md]]`
- **表示**: ファイル名（拡張子除く）をリンクテキストとして表示
- **例**: `[[../wikilink-test/index.md]]` → "index" として表示

#### 2.1.2 エイリアス付き内部リンク
- **記法**: `[[path/to/file.md|表示名]]`
- **表示**: 指定された表示名をリンクテキストとして表示
- **例**: `[[../wikilink-test/index.md|good name]]` → "good name" として表示

#### 2.1.3 見出しへのリンク（ブロック参照）
- **記法**: `[[path/to/file.md#heading-id]]`
- **表示**: ファイル名と見出しを組み合わせて表示
- **例**: 
  - `[[../wikilink-test/index.md#link to heading]]`
  - `[[../wikilink-test/index.md#見出しへのリンク]]`

#### 2.1.4 リンク切れ処理
- 存在しないファイルへのリンクは特別なスタイルで表示
- **例**: `[[../not-exist/index.md]]` → リンク切れを示すビジュアル表現

### 2.2 画像埋め込み機能

#### 2.2.1 画像の埋め込み
- **記法**: `![[image-file.jpg]]`
- **動作**: 画像をインラインで埋め込み表示
- **例**: `![[blog-placeholder-2.jpg]]`

### 2.3 外部リンク機能

#### 2.3.1 外部URLへのリンク
- **記法**: `[[https://example.com|リンクテキスト]]`
- **動作**: 外部サイトへのリンクとして処理
- **例**: `[[https://www.youtube.com/watch?v=PAAkCSZUG1c|talk]]`

## 3. 非機能要件

### 3.1 パフォーマンス
- ビルド時にWikilinkを標準的なHTMLリンクに変換
- 大量のWikilinkが存在してもビルド時間に大きな影響を与えない

### 3.2 互換性
- Astro v5.12.8 と互換性を保つ
- MDXとの共存が可能
- 既存のMarkdownリンク記法と併用可能

### 3.3 保守性
- remarkプラグインとして実装し、独立性を保つ
- テストカバレッジ80%以上を維持

### 3.4 エラーハンドリング
- リンク切れの検出と報告
- ビルド時にリンク切れ警告を出力
- 不正な記法に対する適切なエラーメッセージ

## 4. 技術仕様

### 4.1 実装方式
- remarkプラグインとして実装
- `/src/plugins/remark-wikilink/` ディレクトリに配置

### 4.2 処理フロー
1. Markdownパース時にWikilink記法を検出
2. リンク先のファイルパスを解決
3. 相対パスから絶対パスへの変換
4. HTMLリンク要素に変換
5. リンク切れチェック

### 4.3 設定オプション
```javascript
{
  // ベースディレクトリ
  baseDir: './src/content',
  
  // リンク切れ時の動作
  brokenLinkBehavior: 'warn' | 'error' | 'ignore',
  
  // カスタムリンク解決関数
  resolveLink: (path) => customPath,
  
  // 画像の処理
  processImages: true,
  
  // デバッグモード
  debug: false
}
```

## 5. ユースケース

### 5.1 ブログ記事間のリンク
- ブログ記事から他のブログ記事へのリンク
- 関連記事の参照

### 5.2 画像の管理
- 記事内での画像埋め込み
- 相対パスでの画像参照

### 5.3 ナレッジベースの構築
- ドキュメント間の相互参照
- 用語集へのリンク

## 6. 制約事項

### 6.1 ファイルパス
- 相対パスと絶対パスの両方をサポート
- ファイル拡張子は `.md` と `.mdx` をサポート

### 6.2 特殊文字
- ファイル名に含まれる特殊文字は適切にエスケープ
- 日本語ファイル名をサポート

## 7. テスト要件

### 7.1 単体テスト
- Wikilink記法のパース
- パス解決ロジック
- HTML変換処理

### 7.2 統合テスト
- Astroビルドプロセスとの統合
- MDXファイルでの動作確認
- リンク切れ検出

### 7.3 E2Eテスト
- ブラウザでのリンク動作確認
- 画像表示確認

## 8. 成功基準

1. `/src/content/blog/ofm-test/index.md` のすべてのWikilinkが正しく変換される
2. ビルドエラーが発生しない
3. リンク切れが適切に検出される
4. パフォーマンスの劣化が5%以内
5. すべてのテストが合格する

## 9. リスクと対策

### 9.1 リスク
- 既存のMarkdown処理との競合
- パフォーマンスの低下
- 複雑なパス解決によるバグ

### 9.2 対策
- 段階的な実装とテスト
- パフォーマンス測定の実施
- エラーログの充実

## 10. 今後の拡張可能性

- タグのサポート (`#tag`)
- バックリンクの自動生成
- グラフビューの実装
- ブロック埋め込み (`![[file#^block-id]]`)
- PDFやその他のファイル形式のサポート