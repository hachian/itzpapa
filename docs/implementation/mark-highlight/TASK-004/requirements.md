# TASK-004: エッジケースとセキュリティ対応 - TDD要件定義

## 対象要件

- **REQ-101**: システムはコードブロック内の `==` 記法を無視し、ハイライト処理を行ってはならない
- **REQ-102**: システムは不正なHTMLタグ、スクリプト、イベントハンドラーを含む入力に対して適切にエスケープ処理を行わなければならない
- **REQ-103**: システムは不正な `==` 記法（奇数個、ネスト、無効な文字列）を検出し、適切にハンドリングしなければならない
- **NFR-101**: システムはXSS攻撃に対する耐性を持ち、悪意のあるスクリプトの実行を防止しなければならない
- **NFR-102**: システムはエラー発生時に適切なフォールバック処理を行い、システム全体の安定性を保持しなければならない

## 実装対象

### 1. コードブロック内の無視機能

#### 1.1 インラインコードブロック内の無視
- **要件**: インラインコード（`code`）内の `==` は処理しない
- **実装**: remarkプラグインでの親ノード判定を拡張
- **テストケース**:
  ```markdown
  入力: `==コード内のハイライト==`
  期待: `==コード内のハイライト==` (変換されない)
  ```

#### 1.2 ブロックコード内の無視
- **要件**: コードブロック（```code```）内の `==` は処理しない
- **実装**: 親ノードタイプ `code` の検証を強化
- **テストケース**:
  ```markdown
  入力:
  ```
  function test() {
    return "==ハイライトしない==";
  }
  ```
  期待: 内容がそのまま保持される
  ```

#### 1.3 HTMLの `<code>` タグ内の無視
- **要件**: HTML形式のコードタグ内も無視する
- **実装**: HTMLパーサーとの連携による判定
- **テストケース**:
  ```html
  入力: <code>==HTMLコード内==</code>
  期待: <code>==HTMLコード内==</code> (変換されない)
  ```

### 2. HTMLエスケープ処理の強化

#### 2.1 基本的なHTMLエスケープ
- **要件**: 危険なHTML文字の適切なエスケープ
- **実装対象文字**:
  - `<` → `&lt;`
  - `>` → `&gt;`
  - `&` → `&amp;`
  - `"` → `&quot;`
  - `'` → `&#x27;`
- **テストケース**:
  ```markdown
  入力: ==<div>テスト</div>==
  期待: <mark>&lt;div&gt;テスト&lt;/div&gt;</mark>
  ```

#### 2.2 スクリプトタグのエスケープ
- **要件**: スクリプトタグの完全な無効化
- **実装**: スクリプトタグの検出と変換
- **テストケース**:
  ```markdown
  入力: ==<script>alert('XSS')</script>==
  期待: <mark>&lt;script&gt;alert(&#x27;XSS&#x27;)&lt;/script&gt;</mark>
  ```

#### 2.3 イベントハンドラーのエスケープ
- **要件**: onclick、onload等のイベントハンドラー属性を無効化
- **実装**: 属性パターンの検出とエスケープ
- **テストケース**:
  ```markdown
  入力: ==<div onclick="alert('XSS')">クリック</div>==
  期待: <mark>&lt;div onclick=&quot;alert(&#x27;XSS&#x27;)&quot;&gt;クリック&lt;/div&gt;</mark>
  ```

### 3. 不正記法のハンドリング

#### 3.1 奇数個の = の処理
- **要件**: 奇数個の `=` がある場合は処理しない
- **実装**: 正規表現パターンの改良
- **テストケース**:
  ```markdown
  入力: ===テスト===
  期待: ===テスト=== (変換されない)
  ```

#### 3.2 空の記法の処理
- **要件**: `====` や `== ==` は処理しない
- **実装**: 内容検証の強化
- **テストケース**:
  ```markdown
  入力1: ====
  期待1: ==== (変換されない)
  
  入力2: == ==
  期待2: == == (変換されない)
  ```

#### 3.3 改行を含む記法の処理
- **要件**: 改行を含む `==` は処理しない
- **実装**: 正規表現に改行除外パターンを追加
- **テストケース**:
  ```markdown
  入力:
  ==テスト
  改行==
  期待: 変換されない
  ```

#### 3.4 ネストした記法の処理
- **要件**: `====テスト====` のようなネストは処理しない
- **実装**: 開始・終了パターンの厳密な判定
- **テストケース**:
  ```markdown
  入力: ====テスト====
  期待: ====テスト==== (変換されない)
  ```

### 4. セキュリティ対策の実装

#### 4.1 XSS攻撃の防止
- **要件**: 全ての潜在的XSSベクターを無効化
- **実装範囲**:
  - スクリプトタグ: `<script>`, `</script>`
  - イベントハンドラー: `onclick`, `onload`, `onerror`, etc.
  - データURIスキーム: `javascript:`, `data:text/html`
  - HTMLエンティティによる回避の防止

#### 4.2 入力値検証の強化
- **要件**: 入力文字列の妥当性検証
- **検証項目**:
  - 文字列長の制限（10,000文字以下）
  - 無効なUnicode文字の除外
  - 制御文字の除外

#### 4.3 出力の安全性保証
- **要件**: 生成されるHTMLの安全性を保証
- **実装**:
  - 出力HTMLの再検証
  - 許可されたタグのホワイトリスト
  - DOMPurifyライクな後処理

## 非機能要件

### 1. パフォーマンス要件

#### 1.1 処理性能の維持
- **要件**: 追加処理によるパフォーマンス劣化を5%以下に抑制
- **測定方法**: 1000文字、10個のハイライトを含む文書の処理時間
- **目標値**: 100ms以下（既存実装比105%以下）

#### 1.2 メモリ使用量の制限
- **要件**: メモリ使用量の増加を最小限に抑制
- **測定方法**: 大量のハイライトを含む文書の処理時のメモリ使用量
- **目標値**: 既存実装比110%以下

### 2. セキュリティ要件

#### 2.1 XSS防止の徹底
- **要件**: OWASPトップ10のXSS攻撃パターンに対する完全な防御
- **テスト範囲**:
  - Reflected XSS
  - Stored XSS
  - DOM-based XSS
- **合格基準**: 全ての攻撃パターンが無効化される

#### 2.2 CSP（Content Security Policy）準拠
- **要件**: 生成されるHTMLがCSPに違反しない
- **制約**:
  - インラインスクリプトを含まない
  - unsafe-evalを要求しない
  - 外部リソースへの不正な参照を行わない

### 3. エラーハンドリング要件

#### 3.1 例外処理の徹底
- **要件**: すべての例外を適切にキャッチし、フォールバック処理を実行
- **フォールバック動作**:
  - エラー発生時は元のテキストをそのまま返す
  - ログ出力により問題を記録
  - プラグイン全体の停止を防ぐ

#### 3.2 不正入力への耐性
- **要件**: 悪意のある入力に対してもシステムが安定動作
- **対応範囲**:
  - 極端に長い文字列
  - 無効なUnicode文字
  - 大量の特殊文字

## 受け入れ基準

### 1. 機能要件の達成

#### 1.1 コードブロック無視機能
- [ ] インラインコード内の `==` が処理されない
- [ ] ブロックコード内の `==` が処理されない
- [ ] HTMLコードタグ内の `==` が処理されない

#### 1.2 HTMLエスケープ処理
- [ ] 基本的なHTML文字が適切にエスケープされる
- [ ] スクリプトタグが完全に無効化される
- [ ] イベントハンドラーが無効化される

#### 1.3 不正記法のハンドリング
- [ ] 奇数個の `=` が処理されない
- [ ] 空の記法が処理されない
- [ ] 改行を含む記法が処理されない
- [ ] ネストした記法が処理されない

### 2. セキュリティ要件の達成

#### 2.1 XSS防止
- [ ] OWASPトップ10のXSS攻撃パターンが全て無効化される
- [ ] 自動化されたセキュリティスキャンで脆弱性が検出されない
- [ ] 手動ペネトレーションテストで脆弱性が発見されない

#### 2.2 CSP準拠
- [ ] 生成されるHTMLがCSPに違反しない
- [ ] strict-CSPで動作確認される

### 3. パフォーマンス要件の達成

#### 3.1 処理性能
- [ ] 1000文字、10個ハイライトの処理時間が100ms以下
- [ ] 既存実装比105%以下のパフォーマンス劣化
- [ ] 10,000個のハイライトでも5秒以下で処理完了

#### 3.2 メモリ効率
- [ ] メモリ使用量が既存実装比110%以下
- [ ] メモリリークが発生しない
- [ ] ガベージコレクションの頻度が増加しない

### 4. 品質要件の達成

#### 4.1 テストカバレッジ
- [ ] 単体テストのカバレッジが95%以上
- [ ] 統合テストのカバレッジが90%以上
- [ ] セキュリティテストが100%成功

#### 4.2 既存機能との互換性
- [ ] wikilinkプラグインとの共存で問題が発生しない
- [ ] calloutプラグインとの共存で問題が発生しない
- [ ] 既存のmarkdown機能が正常に動作する

## 制約事項

### 1. 技術的制約

#### 1.1 remarkプラグインの制約
- プラグインAPIの仕様に準拠する必要がある
- ASTノードの型システムを遵守する必要がある
- 他のプラグインとの処理順序に依存する制約がある

#### 1.2 パフォーマンス制約
- 大量のテキスト処理時の性能劣化を避ける必要がある
- 正規表現の複雑化によるコンパイル時間の増加を制限する
- メモリ使用量の急激な増加を防ぐ必要がある

#### 1.3 セキュリティ制約
- クライアントサイドでの実行環境での安全性確保
- サーバーサイドレンダリングでの安全性確保
- 外部ライブラリへの依存を最小限に抑制

### 2. 互換性制約

#### 2.1 既存プラグインとの競合回避
- processing priority の調整が必要
- ASTノード構造の変更による他プラグインへの影響を回避
- 既存のmarkdown記法との混在時の一貫した動作

#### 2.2 ブラウザ互換性
- モダンブラウザでの動作保証（Chrome 90+, Firefox 88+, Safari 14+）
- レガシーブラウザでの基本的な動作保証
- モバイルブラウザでの正常な表示

### 3. 運用制約

#### 3.1 デバッグ・監視
- エラー発生時の詳細なログ出力
- パフォーマンス問題の特定のためのメトリクス収集
- セキュリティインシデント発生時の追跡可能性

#### 3.2 メンテナンス性
- 新しい攻撃パターンへの対応の容易性
- 性能改善のための拡張性
- テストケースの追加・更新の容易性

## 実装アプローチ

### フェーズ1: コードブロック無視機能の実装
1. remarkプラグインでの親ノード判定ロジックの拡張
2. コードブロック検出の精度向上
3. テストケースの実装と検証

### フェーズ2: HTMLエスケープ処理の強化
1. 既存のescapeHtml関数の改良
2. XSS攻撃パターンの網羅的な対応
3. セキュリティテストの実装

### フェーズ3: 不正記法ハンドリングの実装
1. 正規表現パターンの改良
2. 入力値検証の強化
3. エラーハンドリングの実装

### フェーズ4: セキュリティ対策の総合的な実装
1. 複合的な攻撃パターンへの対応
2. CSP準拠の確認
3. ペネトレーションテストの実施

## 成功基準

### 機能要件
- [ ] 全てのコードブロック無視機能が正常に動作
- [ ] 全てのHTMLエスケープ処理が正常に動作
- [ ] 全ての不正記法が適切にハンドリングされる

### 品質要件
- [ ] 全テストケースが成功（成功率100%）
- [ ] 既存機能との競合がない
- [ ] パフォーマンス要件を満たしている

### セキュリティ要件
- [ ] XSS攻撃に対する完全な耐性
- [ ] セキュリティスキャンで脆弱性が検出されない
- [ ] CSP準拠が確認される