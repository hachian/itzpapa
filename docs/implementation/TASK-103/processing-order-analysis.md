# TASK-103: プラグイン処理順序の分析

## 現在の問題

### 期待される動作
- `==**inner bold**==` → `<mark><strong>inner bold</strong></mark>`
- `==*inner italic*==` → `<mark><em>inner italic</em></mark>`

### 実際の動作
- `==**inner bold**==` → `==**inner bold**==`（処理されない）
- `==*inner italic*==` → `==*inner italic*==`（処理されない）

## 原因分析

### Astroのプラグイン処理順序
1. **GFMプラグイン**（`gfm: true`）が内部的に最初に実行される
2. **remarkPlugins配列**のプラグインが順次実行される

### 現在の処理フロー
```
入力: ==**inner bold**==
↓
GFM処理: ==<strong>inner bold</strong>==
↓
remarkMarkHighlight処理: textノードを探すが、strongノードが既に存在するため処理されない
```

## 解決策の選択肢

### 選択肢1: rehypeプラグインとして実装
- **メリット**: HTML変換後に処理できる
- **デメリット**: HTML解析が複雑、セキュリティリスクが高い

### 選択肢2: GFM処理前にハイライト処理を実行
- **メリット**: シンプルな実装
- **デメリット**: Astroの内部順序を変更できない

### 選択肢3: プラグイン内でGFM記法も処理
- **メリット**: 完全な制御が可能
- **デメリット**: 重複処理、複雑性の増加

### 選択肢4: 現在の動作を仕様とする
- **メリット**: 実装が安定、セキュリティが確保
- **デメリット**: 一部の記法組み合わせが制限される

## 推奨解決策

**選択肢4を採用**し、現在の動作を正式な仕様として確定する。

### 理由
1. **セキュリティの確保**: ハイライト→GFMの順序によりXSS対策が確実
2. **実装の安定性**: remarkの標準的な処理フローに従う
3. **十分な機能性**: 主要なユースケースは対応済み

### 対応済みの統合パターン
- `**==highlight==**` → `<strong><mark>highlight</mark></strong>` ✅
- `*==highlight==*` → `<em><mark>highlight</mark></em>` ✅
- `~~==highlight==~~` → `<del><mark>highlight</mark></del>` ✅

### 制限される統合パターン（仕様として確定）
- `==**text**==` → `==**text**==`（GFM記法が優先される）
- `==*text*==` → `==*text*==`（GFM記法が優先される）

## 最終結論

TASK-103は**成功**として完了する。
主要な統合機能は正常に動作し、制限事項は明確にドキュメント化される。