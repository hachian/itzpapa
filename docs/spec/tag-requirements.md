# タグ機能 要件定義書

## 概要

Obsidianスタイルのタグシステムを実装し、ブログコンテンツの効率的な分類と検索を可能にする。特に階層構造を持つタグ（ネストタグ）のサポートを重点的に実装する。

## ユーザストーリー

### ストーリー1: タグによるコンテンツ分類

- **である** ブログ執筆者 **として**
- **私は** 記事にタグを付けて分類 **をしたい**
- **そうすることで** コンテンツの整理と管理が容易になる

### ストーリー2: 階層タグによる詳細な分類

- **である** ブログ執筆者 **として**  
- **私は** 階層構造を持つタグ（例：#tech/web/frontend）を使用 **したい**
- **そうすることで** より詳細で体系的な分類が可能になる

### ストーリー3: タグによるコンテンツ検索

- **である** ブログ読者 **として**
- **私は** タグを使って関連記事を検索 **したい**
- **そうすることで** 興味のあるコンテンツを効率的に見つけられる

## 機能要件（EARS記法）

### 通常要件

- REQ-001: システムは `#` で始まる文字列をタグとして認識しなければならない
- REQ-002: システムは タグを記事のメタデータとして保存しなければならない
- REQ-003: システムは タグをクリック可能なリンクとして表示しなければならない
- REQ-004: システムは 階層タグ（例：#tech/web/frontend）をサポートしなければならない
- REQ-005: システムは タグ一覧ページを提供しなければならない
- REQ-006: システムは タグクラウドまたはタグツリービューを表示しなければならない

### 条件付き要件

- REQ-101: タグに `/` が含まれる場合、システムは それを階層タグとして処理しなければならない
- REQ-102: 親タグ（例：#tech）がクリックされた場合、システムは 子タグ（#tech/web など）を含む全ての関連記事を表示しなければならない
- REQ-103: 子タグ（例：#tech/web/frontend）がクリックされた場合、システムは そのタグに完全一致する記事のみを表示しなければならない
- REQ-104: タグが記事の本文中に存在する場合、システムは それをインラインタグとして表示しなければならない
- REQ-105: タグがfrontmatterに存在する場合、システムは それをメタデータタグとして処理しなければならない

### 状態要件

- REQ-201: タグページを表示している場合、システムは そのタグを持つ全記事のリストを表示しなければならない
- REQ-202: タグツリービューを表示している場合、システムは 階層構造を視覚的に表現しなければならない
- REQ-203: 記事表示時、システムは その記事に関連する全タグを表示しなければならない

### オプション要件

- REQ-301: システムは タグのオートコンプリート機能を提供してもよい
- REQ-302: システムは タグの使用頻度を視覚的に表現してもよい（タグクラウド）
- REQ-303: システムは タグのエイリアス機能をサポートしてもよい
- REQ-304: システムは タグの説明文を管理してもよい

### 制約要件

- REQ-401: タグ名は 英数字、ハイフン、アンダースコア、日本語文字のみを含まなければならない
- REQ-402: タグ名は スペースを含んではならない
- REQ-403: タグの階層は 最大5レベルまでとしなければならない
- REQ-404: 単一の記事は 最大20個のタグを持つことができる

## 非機能要件

### パフォーマンス

- NFR-001: タグページの表示は 1000記事まで2秒以内に完了しなければならない
- NFR-002: タグの自動補完は 入力後100ms以内に候補を表示しなければならない
- NFR-003: タグツリーの展開/折りたたみは 即座に（50ms以内）反応しなければならない

### セキュリティ

- NFR-101: タグ名の入力は XSS攻撃を防ぐためサニタイズしなければならない
- NFR-102: タグ検索は SQLインジェクションを防ぐため適切にエスケープしなければならない

### ユーザビリティ

- NFR-201: タグは 視覚的に識別しやすいスタイル（例：背景色、枠線）を持たなければならない
- NFR-202: 階層タグは インデントまたはツリー構造で階層関係を明確に表示しなければならない
- NFR-203: タグは キーボードナビゲーションに対応しなければならない

## Edgeケース

### エラー処理

- EDGE-001: 存在しないタグがURLで指定された場合、適切な404ページを表示する
- EDGE-002: 循環参照を持つタグ構造が作成された場合、エラーを表示する
- EDGE-003: タグ名が最大長を超えた場合、適切にトリミングまたはエラー表示する

### 境界値

- EDGE-101: タグ名が1文字の場合も正常に処理する
- EDGE-102: タグ名が最大長（64文字）の場合も正常に処理する
- EDGE-103: 階層の深さが最大値（5レベル）の場合も正常に処理する
- EDGE-104: 記事に0個のタグが設定されている場合も正常に処理する
- EDGE-105: 記事に最大数（20個）のタグが設定されている場合も正常に処理する

### 特殊文字処理

- EDGE-201: タグ名に日本語（ひらがな、カタカナ、漢字）が含まれる場合も正常に処理する
- EDGE-202: タグ名にハイフンやアンダースコアが含まれる場合も正常に処理する
- EDGE-203: 複数の連続したスラッシュ（//）が含まれる場合、正規化する

## 受け入れ基準

### 機能テスト

- [ ] 単純なタグ（#tag）が認識され、リンクとして機能する
- [ ] 階層タグ（#parent/child）が正しく認識される
- [ ] 階層タグの親子関係が正しく処理される
- [ ] タグクリック時に関連記事一覧が表示される
- [ ] タグ一覧ページが正しく表示される
- [ ] タグツリービューが階層構造を正しく表示する
- [ ] frontmatterのタグが正しく処理される
- [ ] インラインタグが正しく表示される
- [ ] 日本語タグが正しく処理される
- [ ] タグの大文字小文字が適切に処理される

### 非機能テスト

- [ ] 1000記事でのタグページ表示が2秒以内
- [ ] タグ入力のXSS対策が機能している
- [ ] タグがアクセシブル（スクリーンリーダー対応）
- [ ] モバイルデバイスでタグが適切に表示される
- [ ] ダークモードでタグが視認できる

## 実装の優先順位

1. **Phase 1（必須）**
   - 基本的なタグ認識と表示
   - frontmatterでのタグ定義
   - タグページの基本機能

2. **Phase 2（重要）**
   - 階層タグのサポート
   - タグツリービュー
   - 親タグによる子タグ記事の包含検索

3. **Phase 3（オプション）**
   - タグクラウド
   - タグのオートコンプリート
   - タグの使用統計

## 技術的考慮事項

### データ構造

```typescript
interface Tag {
  name: string;           // タグ名（例: "tech/web/frontend"）
  slug: string;          // URLセーフな形式
  parent?: string;       // 親タグ（例: "tech/web"）
  children: string[];    // 子タグのリスト
  count: number;         // 使用回数
  level: number;         // 階層の深さ（0から開始）
}

interface TagHierarchy {
  [key: string]: {
    tag: Tag;
    children: TagHierarchy;
  }
}
```

### URL設計

- `/tags` - タグ一覧ページ
- `/tags/[slug]` - 特定タグの記事一覧
- `/tags/tree` - タグツリービュー（オプション）

### スタイリング

- タグは `#` プレフィックス付きで表示
- 階層タグはスラッシュ `/` で区切って表示
- ホバー時にアンダーラインまたは色変更で反応