# レスポンシブ対応 要件定義書

## 概要

既存のAstroベースのWebサイトに対して、様々なデバイスやスクリーンサイズに適応するレスポンシブデザインを実装する。モバイルファーストアプローチを採用し、ユーザビリティを重視した最適化を行う。

## ユーザストーリー

### ストーリー1: モバイルユーザーの閲覧体験

- **である** モバイルデバイスユーザー **として**
- **私は** スマートフォンで快適にサイトを閲覧したい
- **そうすることで** 外出先でも情報にアクセスできる

### ストーリー2: タブレットユーザーの閲覧体験

- **である** タブレットユーザー **として**
- **私は** 中間サイズの画面で適切にコンテンツが表示されることを期待する
- **そうすることで** リラックスした環境で読みやすい体験を得られる

### ストーリー3: デスクトップユーザーの作業効率

- **である** デスクトップユーザー **として**
- **私は** 大画面を活用した効率的なレイアウトで作業したい
- **そうすることで** 生産性を向上させることができる


## 機能要件（優先度順）

### 最重要要件（横スクロール防止）

- **REQ-1**: システムは全ての画面幅（320px〜1920px）で水平スクロールを発生させてはならない
- **REQ-2**: システムは固定width指定（720px等）を撤廃し、max-widthまたはfr単位を使用しなければならない
- **REQ-3**: システムはグリッドオーバーフローを防ぐため、適切にmin-width: 0を設定しなければならない

### 基本レスポンシブ要件

- **REQ-4**: システムは3つのブレークポイント（767px, 1023px）で適切なレイアウトを提供しなければならない
- **REQ-5**: システムはタッチターゲットを44px以上のサイズで提供しなければならない
- **REQ-6**: システムは画像を各画面サイズに最適化（max-width: 100%）しなければならない

### 既存機能互換要件

- **REQ-7**: システムは既存の目次機能（768px基準）を破綻させてはならない
- **REQ-8**: システムは既存のタグ機能（640px基準）を破綻させてはならない
- **REQ-9**: システムはウィキリンク、マークハイライト機能を維持しなければならない

### 拡張要件（オプション）

- **REQ-10**: システムはダークモード対応のレスポンシブデザインを提供してもよい


## 非機能要件

### パフォーマンス

- NFR-001: レスポンシブ画像の読み込み時間は3秒以内でなければならない
- NFR-002: レイアウト変更時のリフロー時間は100ms以内でなければならない
- NFR-003: 初回ページ読み込み時間が既存より20%以上劣化してはならない

### ユーザビリティ

- NFR-101: タッチターゲットのサイズは44px以上でなければならない
- NFR-102: テキストの可読性を保つため、最小フォントサイズは14pxでなければならない
- NFR-103: コンテンツの水平スクロールは発生してはならない

### アクセシビリティ

- NFR-201: スクリーンリーダーでの読み上げ順序が論理的でなければならない
- NFR-202: キーボードナビゲーションが全ての画面サイズで動作しなければならない
- NFR-203: 色のコントラストがWCAG 2.1 AA基準を満たさなければならない

### 互換性

- NFR-301: iOS Safari、Android Chrome、デスクトップブラウザで動作しなければならない
- NFR-302: CSS Grid、Flexboxをサポートするブラウザで動作しなければならない


## 実装方針

### 統合ブレークポイント定義

```css
/* 既存5つ（640px, 720px, 768px, 1024px, 1440px）を3つに統合 */

/* Mobile - モバイル（〜767px）*/
@media (max-width: 767px) {
  /* 既存640px, 720pxの範囲をカバー */
}

/* Tablet - タブレット（768px〜1023px）*/
@media (min-width: 768px) and (max-width: 1023px) {
  /* 既存768pxを基準として維持 */
}

/* Desktop - デスクトップ（1024px〜）*/
@media (min-width: 1024px) {
  /* 既存1024px, 1440pxを統合 */
}
```

### 統合の根拠

**640px + 720px → 767px以下（Mobile）**
- 現実的には640-720pxの差は微細
- モバイルファーストで一括対応

**768px → 768px-1023px（Tablet）**
- 既存の目次機能が768px基準なので維持
- タブレット縦横両対応

**1024px + 1440px → 1024px以上（Desktop）**
- デスクトップは1024px以上で十分
- 超大画面も同じレイアウトで対応

### 段階的移行計画

#### フェーズ1: ブレークポイント統一（後方互換）
```css
/* 既存機能維持しつつ統一ブレークポイント追加 */
/* global.css 修正予定 */
@media (max-width: 720px) { /* 既存 */ }
@media (max-width: 639px) { /* 新規追加 */ }

/* table-of-contents.css 調整予定 */
@media (max-width: 768px) { /* 既存維持 */ }
```

#### フェーズ2: レイアウト競合解決
```css
/* 優先度調整による競合回避 */
main {
  width: 720px; /* 既存維持 */
  max-width: calc(100% - 2em); /* 既存維持 */
}

/* BlogPost.astro 専用調整 */
.blog-post main {
  width: calc(100% - 2em); /* 上書き */
  max-width: 720px; /* 新規 */
}
```

#### フェーズ3: 理想形への移行
```css
/* 最終的な理想形（慎重に移行） */
main {
  max-width: 720px;
  width: 100%;
}
.blog-layout-with-toc {
  grid-template-columns: 1fr minmax(200px, 300px);
}
```

### 既存実装との統合対象

#### 高優先度（競合リスク高）
- **global.css**: width:720px → 段階的max-width移行
- **table-of-contents.css**: grid 250px固定幅 → minmax()移行
- **BlogPost.astro**: 独自width設定 → 優先度調整

#### 中優先度（部分修正）
- **inline-tag.css**: 640pxブレークポイント → 統一BP適用
- **mark.css**: 720pxブレークポイント → 統一BP適用

#### 低優先度（基本維持）
- **tag-variables.css**: 参照値のみ → 新BP反映
- **Header/Footer**: 既存動作維持 → 漸進的改善

## 受け入れ基準

### 最重要基準（横スクロール防止）

- [ ] 320px〜1920pxの全ての画面幅で水平スクロールが発生しない
- [ ] 固定width指定（720px等）が撤廃されている
- [ ] グリッドオーバーフローが発生していない

### 基本機能テスト

- [ ] 3つのブレークポイント（767px, 1023px）で適切表示される
- [ ] タッチターゲットが44px以上のサイズになっている
- [ ] 画像が各画面サイズに最適化されている（max-width: 100%）

### 既存機能互換テスト

- [ ] 目次機能（768px基準）が正常動作する
- [ ] タグ機能（640px基準）が正常動作する
- [ ] ウィキリンク、マークハイライト機能が維持されている

### 自動化テスト（Playwright）

- [ ] ビューポート320px、767px、1023px、1200pxでのスクリーンショット比較
- [ ] 横スクロール自動検知（scrollWidth vs clientWidth）
- [ ] レスポンシブレイアウト切り替えテスト
- [ ] 主要ブラウザでの動作確認

### パフォーマンス・アクセシビリティ

- [ ] 初回ページ読み込み時間が20%以上劣化していない
- [ ] Core Web Vitalsが基準内
- [ ] アクセシビリティ（WCAG 2.1 AA）準拠

## 完了定義

1. 全ての受け入れ基準をクリアしている
2. Playwrightテストスイートが完成し、全テストが通る
3. コードレビューが完了している
4. ドキュメント（実装ガイド）が更新されている
5. プロダクションデプロイメントが完了している

## Playwrightテスト実装指針

### 実装予定のテストファイル
```
tests/
├── responsive/
│   ├── viewport-sizes.spec.js      # ビューポートサイズテスト
│   ├── horizontal-scroll.spec.js   # 横スクロール検知
│   ├── layout-switching.spec.js    # レイアウト切り替え
│   ├── touch-interaction.spec.js   # タッチ操作
│   └── visual-regression.spec.js   # ビジュアル回帰テスト
```

### 重要なテストケース
- **ビューポート切り替え時の要素配置確認**
- **横スクロールの自動検知（scrollWidth vs clientWidth）**
- **目次機能のグリッド→フレックス切り替え**
- **タグ機能のレスポンシブ動作**
- **画像・メディア要素の適応確認**

---

**作成日**: 2025-09-17
**最終更新**: 2025-09-17
**要件件数**: 合計10件（最重要3件、基本3件、互換3件、オプション1件）