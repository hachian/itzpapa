# Obsidian Callout機能 要件定義書

## 概要

Astroブログサイトにrehype-calloutsライブラリを利用してObsidianスタイルのcallout機能を実装する。ブロッククォート記法を用いてNote、Warning、Info等の情報ボックスを表示し、コンテンツの可読性と情報の構造化を向上させる。

## ユーザストーリー

### ストーリー1: コンテンツ作成者の情報整理

- **である** ブログ記事作成者 **として**
- **私は** 重要な情報を視覚的に区別して表示 **をしたい**
- **そうすることで** 読者により分かりやすい記事を提供できる

### ストーリー2: 読者の理解促進

- **である** ブログ読者 **として**
- **私は** 重要度や種類に応じて整理された情報 **を見たい**
- **そうすることで** 記事の内容を効率的に理解できる

### ストーリー3: 折りたたみ機能による情報管理

- **である** コンテンツ作成者 **として**
- **私は** 補足情報を折りたたみ表示 **をしたい**
- **そうすることで** メインコンテンツを邪魔せずに詳細情報を提供できる

## 機能要件（EARS記法）

### 通常要件

- REQ-001: システムはrehype-calloutsライブラリを統合しなければならない
- REQ-002: システムはObsidianテーマを適用しなければならない
- REQ-003: システムはブロッククォート記法 `> [!type]` でcalloutを認識しなければならない
- REQ-004: システムは複数のcalloutタイプ（note、warning、info、tip、caution）をサポートしなければならない
- REQ-005: システムは各calloutタイプに対応したアイコンを表示しなければならない

### 条件付き要件

- REQ-101: `> [!type]-` 記法が使用された場合、システムは折りたたみ可能なcalloutを生成しなければならない
- REQ-102: calloutにタイトルが指定された場合、システムはそれをヘッダーとして表示しなければならない
- REQ-103: callout内にMarkdown記法が含まれる場合、システムは正しく処理しなければならない
- REQ-104: 既存のwikilink機能が存在する場合、システムはプラグインの実行順序を適切に制御しなければならない

### 状態要件

- REQ-201: Astro MDXページにある場合、システムはcalloutを正しくレンダリングしなければならない
- REQ-202: 通常のMarkdownページにある場合、システムはcalloutを正しくレンダリングしなければならない

### オプション要件

- REQ-301: システムはカスタムcalloutタイプを追加できてもよい
- REQ-302: システムはcalloutの色やスタイルをカスタマイズできてもよい

### 制約要件

- REQ-401: システムは既存のwikilinkプラグインとの互換性を維持しなければならない
- REQ-402: システムはAstroの既存のmarkdown設定を保持しなければならない
- REQ-403: システムはパフォーマンスへの影響を最小限に抑えなければならない

## 非機能要件

### パフォーマンス

- NFR-001: calloutの処理はページ読み込み時間を500ms以上増加させてはならない
- NFR-002: ビルド時間は既存の時間の120%を超えてはならない

### セキュリティ

- NFR-101: callout内のHTMLタグは適切にサニタイズされなければならない
- NFR-102: XSS攻撃を防ぐためユーザー入力を適切に処理しなければならない

### ユーザビリティ

- NFR-201: calloutの記法は直感的で覚えやすくなければならない
- NFR-202: 折りたたみ機能はキーボード操作でアクセス可能でなければならない
- NFR-203: calloutはモバイルデバイスでも適切に表示されなければならない

### 互換性

- NFR-301: 最新のAstroバージョンと互換性を保たなければならない
- NFR-302: 主要なモダンブラウザで動作しなければならない

## Edgeケース

### エラー処理

- EDGE-001: 不正なcallout記法が入力された場合、システムは通常のブロッククォートとして処理する
- EDGE-002: 未知のcalloutタイプが指定された場合、システムはデフォルトタイプ（note）として処理する
- EDGE-003: callout内で入れ子になったcalloutは適切に処理するか、警告を表示する

### 境界値

- EDGE-101: 空のcalloutが指定された場合、システムは空のcalloutボックスを表示する
- EDGE-102: 非常に長いcalloutタイトルの場合、システムは適切に改行またはトランケートする
- EDGE-103: 大量のcalloutが1ページに含まれる場合でも、パフォーマンスを維持する

### 統合

- EDGE-201: wikilinkプラグインとcalloutプラグインが同じ行で使用された場合、両方が正しく処理される
- EDGE-202: callout内でwikilinkが使用された場合、両方の機能が正しく動作する

## 受け入れ基準

### 機能テスト

- [ ] 基本的なcallout（note、warning、info、tip、caution）が正しく表示される
- [ ] 折りたたみ可能なcalloutが正しく動作する
- [ ] calloutにタイトルを設定できる
- [ ] callout内でMarkdown記法が正しく処理される
- [ ] 各calloutタイプに対応したアイコンが表示される
- [ ] Obsidianテーマのスタイルが適用される
- [ ] MDXページとMarkdownページの両方で動作する

### 非機能テスト

- [ ] ページ読み込み時間が要件を満たす
- [ ] ビルド時間が要件を満たす
- [ ] モバイルデバイスで正しく表示される
- [ ] キーボードナビゲーションが動作する
- [ ] 既存のwikilinkプラグインとの互換性が保たれる

### 統合テスト

- [ ] 既存のAstro設定との互換性が確認される
- [ ] 他のremarkプラグインとの競合がない
- [ ] Git履歴に不適切な変更がない

## 実装技術詳細

### 使用ライブラリ

- **rehype-callouts**: メインのcallout処理ライブラリ
- **Astro**: 静的サイトジェネレーター
- **remark/rehype**: Markdownプロセッサー

### 設定ファイル

- `astro.config.mjs`: rehype-calloutsプラグインの設定
- `package.json`: 依存関係の管理

### スタイル

- Obsidianテーマのサポート
- CSSカスタムプロパティによる色の管理
- レスポンシブデザイン対応