# Obsidian Callout 要件定義書

## 概要

Obsidianで使用されているcallout記法をrehypeプラグインとして実装し、callout内のマークダウンをパースできるようにし、ネスト機能にも対応させる。現在のcodebaseはremarkベースのwikilinkプラグインを持っており、Astroフレームワークを使用している。

## ユーザストーリー

### ストーリー1: 基本的なCalloutの作成

- **である** コンテンツ作成者 **として**
- **私は** `> [!note]` 形式でcalloutを作成 **をしたい**
- **そうすることで** 重要な情報を視覚的に強調して読者に伝えることができる

### ストーリー2: Callout内でのマークダウン利用

- **である** コンテンツ作成者 **として**
- **私は** callout内でマークダウン記法（リンク、画像、コードブロックなど）を使用 **をしたい**
- **そうすることで** リッチなコンテンツを含む情報ボックスを作成できる

### ストーリー3: ネストされたCallout

- **である** コンテンツ作成者 **として**
- **私は** callout内に別のcalloutをネスト **をしたい**
- **そうすることで** 階層的な情報構造を表現できる

### ストーリー4: カスタムタイトル

- **である** コンテンツ作成者 **として**
- **私は** calloutにカスタムタイトルを設定 **をしたい**
- **そうすることで** より具体的で分かりやすい見出しを付けられる

### ストーリー5: 折りたたみ機能

- **である** コンテンツ読者 **として**
- **私は** calloutの内容を折りたたんで表示/非表示を切り替え **をしたい**
- **そうすることで** 必要な情報だけを選択的に表示できる

## 機能要件（EARS記法）

### 通常要件

- REQ-001: システムは `> [!type]` 形式のcallout記法を認識しなければならない
- REQ-002: システムは note、tip、info、warning、danger、success、question、failure、bug、example、quote の11種類のcalloutタイプをサポートしなければならない
- REQ-003: システムは callout内のマークダウンコンテンツを正しくHTMLに変換しなければならない
- REQ-004: システムは rehypeプラグインとして実装されなければならない
- REQ-005: システムは Astro フレームワークと互換性を持たなければならない
- REQ-006: システムは既存のwikilinkプラグインと競合しないように動作しなければならない

### 条件付き要件

- REQ-101: `> [!type Title]` 形式が指定された場合、システムはカスタムタイトルを表示しなければならない
- REQ-102: `> [!type]- ` または `> [!type]+` 形式が指定された場合、システムは折りたたみ可能なcalloutを生成しなければならない
- REQ-103: `> [!type]-` が指定された場合、システムは初期状態を折りたたまれた状態にしなければならない
- REQ-104: `> [!type]+` が指定された場合、システムは初期状態を展開された状態にしなければならない
- REQ-105: callout内で `> [!type]` が使用された場合、システムはネストされたcalloutとして処理しなければならない

### 状態要件

- REQ-201: calloutが他のブロック要素（コードブロック、テーブル等）内にある場合、システムは適切にエスケープして処理しなければならない
- REQ-202: calloutが既存のwikilink記法と併用された場合、システムは両方の機能を正しく動作させなければならない

### オプション要件

- REQ-301: システムは追加のcalloutタイプをプラグイン設定で拡張可能にしてもよい
- REQ-302: システムはcalloutのスタイルをCSSでカスタマイズ可能にしてもよい

### 制約要件

- REQ-401: システムは remarkプラグインではなく rehypeプラグインとして実装されなければならない
- REQ-402: システムは処理順序において既存のwikilink remarkプラグインより後で実行されなければならない
- REQ-403: システムは HTML生成時のパフォーマンスに著しい影響を与えてはならない

## 非機能要件

### パフォーマンス

- NFR-001: callout変換処理は大型ドキュメント（10,000行）で5秒以内に完了しなければならない
- NFR-002: ネストレベル10までのcalloutを適切に処理できなければならない

### セキュリティ

- NFR-101: callout内のHTML要素は適切にサニタイズされなければならない
- NFR-102: XSS攻撃を防ぐためにユーザー入力を適切にエスケープしなければならない

### ユーザビリティ

- NFR-201: calloutはモバイルデバイスでも適切に表示されなければならない
- NFR-202: calloutのアクセシビリティ（スクリーンリーダー対応）を確保しなければならない

### 互換性

- NFR-301: 既存のAstro設定に影響を与えずに追加できなければならない
- NFR-302: Node.js 16以上の環境で動作しなければならない

## Edgeケース

### エラー処理

- EDGE-001: 不正なcalloutタイプが指定された場合、デフォルトの`note`タイプとして処理する
- EDGE-002: callout記法の終了が明確でない場合、ドキュメント末尾またはblock要素の境界まで継続する
- EDGE-003: ネストが深すぎる場合（20レベル超過）、警告を出力し処理を制限する
- EDGE-004: マークダウンのパース処理中にエラーが発生した場合、元のテキストをそのまま出力する

### 境界値

- EDGE-101: 空のcallout（`> [!note]`のみ）は空のcalloutブロックとして表示する
- EDGE-102: 非常に長いタイトル（200文字以上）は省略記号で切り詰める
- EDGE-103: callout内に大量の画像やメディアコンテンツがある場合、レイアウト崩れを防ぐ
- EDGE-104: callout記法の開始文字が行の途中にある場合は通常テキストとして処理する

### 互換性

- EDGE-201: 既存のwikilink記法がcallout内で使用された場合、両方が正しく機能する
- EDGE-202: GFM（GitHub Flavored Markdown）記法との併用時も適切に処理する
- EDGE-203: 既存のコンテンツでcallout記法に類似したパターンがある場合は誤変換を避ける

## 受け入れ基準

### 機能テスト

- [ ] 基本的な11種類のcalloutタイプが正しく表示される
- [ ] カスタムタイトル付きcalloutが正しく表示される
- [ ] 折りたたみ機能（+/-）が正しく動作する
- [ ] callout内のマークダウン記法（リンク、画像、コード、リスト等）が正しく処理される
- [ ] ネストされたcallout（3レベル以上）が正しく表示される
- [ ] wikilink記法がcallout内で正しく動作する
- [ ] 既存のコンテンツに影響を与えない

### 非機能テスト

- [ ] 大型ドキュメントでのパフォーマンステスト
- [ ] モバイルデバイスでの表示テスト
- [ ] アクセシビリティチェック（スクリーンリーダー）
- [ ] セキュリティテスト（XSS脆弱性確認）
- [ ] 異なるブラウザでの互換性テスト

### 統合テスト

- [ ] Astroビルド処理が正常に完了する
- [ ] 静的サイト生成が正しく動作する
- [ ] 開発サーバーでホットリロードが正しく動作する
- [ ] プラグインの追加による既存機能への副作用がない

## 技術的詳細

### プラグイン構成

- **タイプ**: rehypeプラグイン
- **処理タイミング**: remarkプラグイン（wikilink）処理後
- **対象ノード**: HTML要素のblockquote
- **出力形式**: HTMLのcustom elements またはdiv要素

### CSSクラス命名規則

- `.callout` - calloutブロック全体
- `.callout-[type]` - calloutタイプ別スタイル
- `.callout-title` - タイトル部分
- `.callout-content` - コンテンツ部分
- `.callout-foldable` - 折りたたみ可能なcallout
- `.callout-folded` - 折りたたまれた状態

### 設定オプション

```javascript
rehypeCallout({
  types: ['note', 'tip', 'info', 'warning', 'danger', 'success', 'question', 'failure', 'bug', 'example', 'quote'],
  maxNestLevel: 20,
  enableFolding: true,
  customTypes: [] // 追加のカスタムタイプ
})
```