# マークハイライト機能 要件定義書

## 概要

ユーザがマークダウンコンテンツ内で `==文字列==` の記法を使用することで、該当の文字列がマークタグ `<mark>` でハイライト表示される機能を実装する。

## ユーザストーリー

### ストーリー1: 重要な文字のハイライト表示

- **である** ブログ記事の執筆者 **として**
- **私は** 記事内の重要な文字や単語を目立たせたい **をしたい**
- **そうすることで** 読者の注意を重要な箇所に向けることができ、読みやすい記事を作成できる

### ストーリー2: 強調表現の多様化

- **である** コンテンツクリエイター **として**
- **私は** 太字（**）やイタリック（*）とは異なる強調表現を使いたい **をしたい**
- **そうすることで** より豊かな表現力でコンテンツを作成できる

## 機能要件（EARS記法）

### 通常要件

- REQ-001: システムは `==テキスト==` の記法を検出した場合、HTMLの `<mark>テキスト</mark>` タグに変換しなければならない
- REQ-002: システムは複数の `==` ペアが同一行に存在する場合、それぞれを独立してハイライト処理しなければならない
- REQ-003: システムは `==` で囲まれたテキストにインライン記法（太字、イタリック、リンクなど）が含まれている場合、両方を適切にレンダリングしなければならない

### 条件付き要件

- REQ-101: `==` が奇数個存在する場合、システムは処理を行わずそのまま表示しなければならない
- REQ-102: `==` が空の場合（`====`）、システムは処理を行わずそのまま表示しなければならない
- REQ-103: `==` 内にコードブロック記法（`` ` ``）が含まれている場合、システムはコードブロックを優先してハイライト処理を無効にしなければならない

### 状態要件

- REQ-201: 既存のマークダウン処理パイプライン内で動作している場合、システムは他のプラグインとの競合を避けてハイライト処理を実行しなければならない
- REQ-202: プレビューモード表示時、システムはハイライトされたテキストを適切なCSSスタイルで表示しなければならない

### オプション要件

- REQ-301: システムは `==` 記法のネスト（`==外側==内側====`）を処理してもよい
- REQ-302: システムは設定により `==` 記法の処理を無効にできてもよい

### 制約要件

- REQ-401: システムは既存のマークダウン処理パフォーマンスに大きな影響を与えてはならない
- REQ-402: システムはセキュリティリスクを導入してはならない（XSS攻撃の防止）

## 非機能要件

### パフォーマンス

- NFR-001: ハイライト処理は既存のマークダウン処理時間の10%以下の追加時間で完了すること
- NFR-002: 1000文字のテキストに対して10個の `==` 記法が含まれている場合、処理時間は100ms以下であること

### セキュリティ

- NFR-101: `==` 内のテキストはHTMLエスケープ処理を適切に行うこと
- NFR-102: 悪意のあるスクリプト注入を防ぐため、`<mark>` タグ以外のHTMLタグ生成を禁止すること

### ユーザビリティ

- NFR-201: ハイライトされたテキストは視覚的に明確に識別できること
- NFR-202: ハイライトされたテキストはアクセシビリティガイドラインに準拠すること（コントラスト比の確保）

### 互換性

- NFR-301: 既存のObsidianコールアウト機能との共存が可能であること
- NFR-302: 既存のwikilink機能との共存が可能であること

## Edgeケース

### エラー処理

- EDGE-001: `===` のような不正な記法の場合、エラーを発生させずにそのまま表示する
- EDGE-002: `==` が文書の最初や最後に位置する場合でも正常に処理する
- EDGE-003: `==` 内に改行が含まれている場合、処理を行わずそのまま表示する

### 境界値

- EDGE-101: 0文字の場合（`====`）は処理しない
- EDGE-102: 1文字の場合（`==a==`）は正常に処理する
- EDGE-103: 非常に長いテキスト（1000文字以上）でも正常に処理する

### 競合処理

- EDGE-201: 他のマークダウン記法との組み合わせ（`==**太字**==`、`==[リンク](url)==`）で正常に動作する
- EDGE-202: コードブロック内の `==` 記法は処理しない
- EDGE-203: HTMLコメント内の `==` 記法は処理しない

## 受け入れ基準

### 機能テスト

- [ ] `==テスト==` が `<mark>テスト</mark>` に変換される
- [ ] `==一つ目== と ==二つ目==` が両方とも適切に変換される
- [ ] `==**太字**==` が `<mark><strong>太字</strong></mark>` に変換される
- [ ] `==*イタリック*==` が `<mark><em>イタリック</em></mark>` に変換される
- [ ] `==[リンク](https://example.com)==` が適切に変換される
- [ ] `===` は変換されずそのまま表示される
- [ ] `====` は変換されずそのまま表示される
- [ ] `` `==コード==` `` はコードとして扱われ、ハイライト処理されない

### 非機能テスト

- [ ] 既存のマークダウン処理パフォーマンスが10%以下の劣化に留まる
- [ ] ハイライト表示が視覚的に明確に識別できる
- [ ] XSS攻撃に対する耐性がある
- [ ] 既存のObsidianコールアウト機能と競合しない
- [ ] 既存のwikilink機能と競合しない

### 統合テスト

- [ ] Astroプロジェクトのビルドプロセスで正常に動作する
- [ ] 開発サーバーでリアルタイムプレビューが正常に表示される
- [ ] 既存のテストスイートがすべて通過する

## 実装方針

### アプローチ

1. **remarkプラグインとして実装**: 既存のマークダウン処理パイプラインに統合
2. **正規表現による検出**: `==([^=\n]+)==` パターンでテキストを検出
3. **段階的処理**: 他のインライン記法との競合を避けるため、適切な処理順序を設定

### 技術制約

- remarkプラグインエコシステムとの互換性を維持
- 既存のrehypeプラグイン（callout等）との競合回避
- パフォーマンスオーバーヘッドの最小化

## 関連ドキュメント

- [Obsidian Callout要件定義書](./obsidian-callout-requirements.md)
- [Wikilink サポート要件定義書](./wikilink-support-requirements.md)