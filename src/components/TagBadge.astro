---
/**
 * タグバッジコンポーネント
 * 個別のタグを表示するための再利用可能なコンポーネント
 * 
 * 階層タグと単一タグを統一されたスタイルで表示します。
 * CSS変数を使用してテーマとダークモードに対応。
 */

interface Props {
  /** タグ名 */
  tag: string;
  /** タグを表示するURL（省略時はリンクなし） */
  href?: string;
  /** 使用回数（省略時は表示しない） */
  count?: number;
  /** 追加のCSSクラス */
  className?: string;
  /** アクセシビリティ用のaria-label */
  ariaLabel?: string;
}

const { 
  tag, 
  href, 
  count, 
  className = '',
  ariaLabel
} = Astro.props;

// タグ名を正規化（#プレフィックスを確実に追加）
const displayTag = tag.startsWith('#') ? tag : `#${tag}`;

// CSSクラスを構築 - 統一スタイル適用（isHierarchicalによる区別を廃止）
const tagClasses = [
  'tag',
  className
].filter(Boolean).join(' ');

// アクセシビリティ属性
const accessibility = {
  'aria-label': ariaLabel || `タグ: ${tag}${count ? ` (${count}個の記事)` : ''}`,
  'role': href ? 'link' : 'text',
  'tabindex': href ? '0' : undefined
};
---

{href ? (
  <a 
    href={href}
    class={tagClasses}
    {...accessibility}
  >
    <span class="tag-text">{displayTag}</span>
    {count && count > 0 && (
      <span class="tag-count" aria-hidden="true">
        {count}
      </span>
    )}
  </a>
) : (
  <span 
    class={tagClasses}
    {...accessibility}
  >
    <span class="tag-text">{displayTag}</span>
    {count && count > 0 && (
      <span class="tag-count" aria-hidden="true">
        {count}
      </span>
    )}
  </span>
)}

<style>
  .tag {
    /* タグ用色相（tag-variables.cssで定義、フォールバック用にここでも定義） */
    --tag-hue: var(--primary-hue);

    display: inline-flex;
    align-items: center;
    gap: 0.25em;
    padding: var(--tag-padding-y, 0.2em) var(--tag-padding-x, 0.6em);
    margin: 0 var(--tag-margin-x, 0.2em) var(--tag-margin-y, 0.2em) 0;
    background-color: var(--tag-bg, oklch(97% 0.02 var(--tag-hue)));
    color: var(--tag-color, oklch(48% 0.22 var(--tag-hue)));
    border: 1px solid var(--tag-border, oklch(88% 0.10 var(--tag-hue)));
    border-radius: var(--tag-border-radius, 1rem);
    font-size: var(--tag-font-size, 0.875rem);
    font-weight: var(--tag-font-weight, 500);
    line-height: var(--tag-line-height, 1.2);
    text-decoration: none;
    transition: all var(--tag-transition-duration, 0.2s) var(--tag-transition-easing, ease);
    white-space: nowrap;
    cursor: default;
  }
  
  .tag:where(a) {
    cursor: pointer;
  }
  
  
  /* ホバー効果 - 統一スタイル */
  .tag:where(a):hover,
  .tag:where(a):focus {
    background-color: var(--tag-hover-bg, oklch(55% 0.24 var(--tag-hue)));
    color: var(--tag-hover-color, oklch(100% 0 0));
    border-color: var(--tag-hover-border, oklch(55% 0.24 var(--tag-hue)));
    transform: var(--tag-hover-transform, translateY(-1px));
    box-shadow: var(--tag-hover-shadow, 0 2px 4px oklch(0% 0 0 / 0.1));
  }

  /* フォーカス表示 */
  .tag:where(a):focus {
    outline: 2px solid var(--tag-focus-color, oklch(55% 0.24 var(--tag-hue)));
    outline-offset: var(--tag-focus-offset, 2px);
  }
  
  .tag-text {
    font-family: inherit;
  }
  
  .tag-count {
    background-color: var(--tag-count-bg, oklch(100% 0 0 / 0.3));
    color: inherit;
    padding: var(--tag-count-padding-y, 0.1em) var(--tag-count-padding-x, 0.4em);
    border-radius: var(--tag-count-border-radius, 0.75rem);
    font-size: var(--tag-count-font-size, 0.75em);
    font-weight: var(--tag-count-font-weight, 600);
    min-width: var(--tag-count-min-width, 1.2em);
    text-align: center;
  }
  
  /* ダークモード対応 - 統一スタイル */
  html.dark .tag {
    background-color: var(--tag-bg, oklch(25% 0.12 var(--tag-hue)));
    color: var(--tag-color, oklch(88% 0.10 var(--tag-hue)));
    border-color: var(--tag-border, oklch(32% 0.15 var(--tag-hue)));
  }

  html.dark .tag:where(a):hover,
  html.dark .tag:where(a):focus {
    background-color: var(--tag-hover-bg, oklch(55% 0.24 var(--tag-hue)));
    color: var(--tag-hover-color, oklch(100% 0 0));
    border-color: var(--tag-hover-border, oklch(55% 0.24 var(--tag-hue)));
  }
  
  /* 小さい画面での調整 - CSS変数使用 */
  @media (max-width: 640px) {
    .tag {
      font-size: var(--tag-mobile-font-size, 0.8rem);
      padding: var(--tag-mobile-padding-y, 0.15em) var(--tag-mobile-padding-x, 0.5em);
    }

    .tag-count {
      font-size: var(--tag-mobile-count-font-size, 0.7em);
      padding: var(--tag-mobile-count-padding-y, 0.05em) var(--tag-mobile-count-padding-x, 0.3em);
    }
  }

  /* アクセシビリティ: タッチデバイス用の最小タップサイズ確保 */
  @media (hover: none) and (pointer: coarse) {
    .tag {
      min-height: 32px;
      padding: var(--tag-mobile-padding-y, 0.1em) var(--tag-mobile-padding-x, 0.45em);
      display: inline-flex;
      align-items: center;
      justify-content: center;
    }
  }

  /* 小画面でのタッチターゲットサイズ確保（ブラウザエミュレーション対応） */
  @media (max-width: 640px) {
    .tag {
      min-height: 32px;
      padding: var(--tag-mobile-padding-y, 0.1em) var(--tag-mobile-padding-x, 0.45em);
      display: inline-flex;
      align-items: center;
      justify-content: center;
    }
  }
</style>