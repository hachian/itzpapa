---
/**
 * タグリストコンポーネント
 * 複数のタグを一覧表示するためのコンポーネント
 */

import TagBadge from './TagBadge.astro';

interface Props {
  /** タグのリスト */
  tags: string[];
  /** タグページのベースURL（デフォルト: /tags/） */
  baseUrl?: string;
  /** 使用回数を表示するか */
  showCount?: boolean;
  /** タグごとの使用回数マップ */
  tagCounts?: Record<string, number>;
  /** 最大表示数（省略時は全て表示） */
  maxTags?: number;
  /** 追加のCSSクラス */
  className?: string;
  /** リスト形式（horizontal | vertical | grid） */
  layout?: 'horizontal' | 'vertical' | 'grid';
  /** タグをソートするか（count | name | none） */
  sortBy?: 'count' | 'name' | 'none';
}

const { 
  tags, 
  baseUrl = '/tags/',
  showCount = false,
  tagCounts = {},
  maxTags,
  className = '',
  layout = 'horizontal',
  sortBy = 'none'
} = Astro.props;

// タグが空の場合は何も表示しない
if (!tags || tags.length === 0) {
  return;
}

// タグをソート
let sortedTags = [...tags];
if (sortBy === 'count') {
  sortedTags.sort((a, b) => (tagCounts[b] || 0) - (tagCounts[a] || 0));
} else if (sortBy === 'name') {
  sortedTags.sort((a, b) => a.localeCompare(b));
}

// 表示数を制限
const displayTags = maxTags ? sortedTags.slice(0, maxTags) : sortedTags;
const hiddenCount = sortedTags.length - displayTags.length;

// レイアウトクラスを構築
const listClasses = [
  'tag-list',
  `tag-list-${layout}`,
  className
].filter(Boolean).join(' ');

// タグのスラッグを生成
function tagToSlug(tag: string): string {
  return encodeURIComponent(tag.replace(/\//g, '-').toLowerCase());
}

// 階層タグかどうかを判定
function isHierarchical(tag: string): boolean {
  return tag.includes('/');
}
---

<div class={listClasses} role="list" aria-label="タグ一覧">
  {displayTags.map((tag) => (
    <TagBadge
      tag={tag}
      href={`${baseUrl}${tagToSlug(tag)}`}
      count={showCount ? tagCounts[tag] : undefined}
      isHierarchical={isHierarchical(tag)}
      ariaLabel={`${tag}タグの記事を表示`}
    />
  ))}
  
  {hiddenCount > 0 && (
    <span class="tag-more" aria-label={`他に${hiddenCount}個のタグがあります`}>
      +{hiddenCount}個
    </span>
  )}
</div>

<style>
  .tag-list {
    display: flex;
    align-items: flex-start;
    margin: 0.5em 0;
  }
  
  .tag-list-horizontal {
    flex-direction: row;
    flex-wrap: wrap;
    gap: 0.25em;
  }
  
  .tag-list-vertical {
    flex-direction: column;
    gap: 0.5em;
    align-items: flex-start;
  }
  
  .tag-list-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
    gap: 0.5em;
  }
  
  .tag-more {
    display: inline-flex;
    align-items: center;
    padding: 0.2em 0.6em;
    background-color: var(--gray-100, #f5f5f5);
    color: var(--gray-600, #666);
    border: 1px solid var(--gray-200, #e0e0e0);
    border-radius: 1rem;
    font-size: 0.875rem;
    font-style: italic;
    white-space: nowrap;
  }
  
  /* ダークモード対応 */
  html.dark .tag-more {
    background-color: var(--gray-800, #2d3748);
    color: var(--gray-300, #cbd5e0);
    border-color: var(--gray-600, #4a5568);
  }
  
  /* レスポンシブ対応 */
  @media (max-width: 640px) {
    .tag-list-grid {
      grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
      gap: 0.25em;
    }
    
    .tag-more {
      font-size: 0.8rem;
      padding: 0.15em 0.5em;
    }
  }
  
  /* アクセシビリティ: 縮小時の最小タップサイズ確保 */
  @media (hover: none) and (pointer: coarse) {
    .tag-list :global(.tag) {
      min-height: 44px;
      min-width: 44px;
      justify-content: center;
    }
  }
</style>