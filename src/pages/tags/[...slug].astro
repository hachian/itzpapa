---
/**
 * タグ詳細ページ
 * 特定のタグを持つ記事一覧を表示
 * 親タグの場合は子タグの記事も含む
 */

import { getCollection } from 'astro:content';
import BaseHead from '../../components/BaseHead.astro';
import Breadcrumb from '../../components/Breadcrumb.astro';
import Header from '../../components/Header.astro';
import Footer from '../../components/Footer.astro';
import FormattedDate from '../../components/FormattedDate.astro';
import TagBadge from '../../components/TagBadge.astro';
import { TagService } from '../../utils/tag/service';
import { removeDatePrefix } from '../../plugins/utils/index.js';
import { slugToTag, isDescendantTag } from '../../utils/tag/validation';
import { t, getLanguage } from '../../i18n';

export async function getStaticPaths() {
  // 全ブログ記事を取得（本番環境ではdraft記事を除外）
  const posts = await getCollection('blog', ({ data }) => {
    return import.meta.env.PROD ? data.draft !== true : true;
  });

  // タグサービスを使ってタグ情報を収集
  const tagService = new TagService();

  posts.forEach(post => {
    const frontmatterTags = post.data.tags || [];
    tagService.addPostTags(post.id, frontmatterTags, []);
  });

  // 全タグのスラッグを生成（公開記事が0件のタグは除外）
  const allTags = tagService.getAllTags().filter(tag => tag.count > 0);

  return allTags.map(tag => {
    // タグ名を階層に応じて配列に分割（スラッシュをそのまま使用）
    const slugParts = tag.name.split('/');

    return {
      params: {
        slug: slugParts.length === 1 ? slugParts[0] : slugParts.join('/')  // 文字列として渡す
      },
      props: {
        tag,
        posts,
        tagService
      }
    };
  });
}

const { tag, posts, tagService } = Astro.props;
const { slug } = Astro.params;

// スラッグ配列からタグ名を復元（スラッシュで結合）
const tagName = Array.isArray(slug) ? slug.join('/') : slug;

// このタグとその子孫タグを取得
const hierarchy = tagService.getTagHierarchy();
const relatedTags = tagService.getTagWithAllDescendants(tagName);
const relatedTagNames = relatedTags.map(t => t.name);

// タグに関連する記事をフィルタリング
const relatedPosts = posts.filter(post => {
  const postTags = post.data.tags || [];
  
  // frontmatterにこのタグまたは子孫タグが含まれているかチェック
  return postTags.some(postTag => {
    return relatedTagNames.includes(postTag) || 
           postTag === tagName ||
           isDescendantTag(postTag, tagName);
  });
});

// 記事を日付順でソート（新しい順）
const sortedPosts = relatedPosts.sort((a, b) =>
  new Date(b.data.published).getTime() - new Date(a.data.published).getTime()
);

// パンくずリスト用のアイテム配列を構築
function buildBreadcrumbItems(tagName: string) {
  const items = [
    { label: t('breadcrumb.home'), href: '/' },
    { label: t('breadcrumb.tags'), href: '/tags/' }
  ];

  const parts = tagName.split('/');
  for (let i = 0; i < parts.length; i++) {
    const partialTag = parts.slice(0, i + 1).join('/');
    const isLast = i === parts.length - 1;
    items.push({
      label: parts[i],
      href: isLast ? undefined : `/tags/${partialTag.toLowerCase()}/`
    });
  }

  return items;
}

const breadcrumbItems = buildBreadcrumbItems(tagName);
const isHierarchical = tagName.includes('/');

// 関連する子タグを取得
const childTags = tagService.getAllTags().filter(t => 
  t.parent === tagName && t.name !== tagName
);

// ページメタデータと翻訳
const lang = getLanguage();
const pageTitle = lang === 'ja'
  ? `${tagName} のタグ記事`
  : `Posts tagged: ${tagName}`;
const pageDescription = lang === 'ja'
  ? `${tagName}タグが付けられた${sortedPosts.length}件の記事一覧`
  : `${sortedPosts.length} posts tagged with ${tagName}`;
---

<html lang={lang}>
  <head>
    <BaseHead title={pageTitle} description={pageDescription} />
    <style>
      /* タグ用色相（primaryHueと同じ = シフトなし） */
      :root {
        --tag-hue: var(--primary-hue);
      }

      .tag-page-container {
        width: var(--content-max-width);
        max-width: calc(100% - 2em);
        margin: var(--space-2) auto var(--space-8);
        padding: 0 var(--space-4) var(--space-4);
      }

      .page-header {
        margin-bottom: var(--space-8);
        padding-bottom: var(--space-4);
        border-bottom: 2px solid var(--color-gray-200);
      }

      .page-title {
        font-size: var(--font-size-4xl);
        font-weight: var(--font-weight-bold);
        color: var(--color-text-primary);
        margin: 0 0 var(--space-2) 0;
        display: flex;
        align-items: center;
        gap: var(--space-2);
      }

      .tag-icon {
        font-size: var(--font-size-3xl);
        color: oklch(55% 0.24 var(--tag-hue));
      }

      .page-meta {
        display: flex;
        gap: var(--space-8);
        margin-bottom: var(--space-4);
        font-size: var(--font-size-sm);
        color: var(--color-text-secondary);
      }

      .meta-item {
        display: flex;
        align-items: center;
        gap: var(--space-1);
      }

      .child-tags {
        margin-bottom: var(--space-8);
      }

      .child-tags h2 {
        font-size: var(--font-size-lg);
        margin-bottom: var(--space-2);
        color: var(--color-text-primary);
      }

      .child-tags-list {
        display: flex;
        flex-wrap: wrap;
        gap: var(--space-2);
      }

      .posts-section h2 {
        font-size: var(--font-size-2xl);
        margin-bottom: var(--space-4);
        color: var(--color-text-primary);
        border-bottom: 1px solid var(--color-gray-200);
        padding-bottom: var(--space-2);
      }

      .posts-grid {
        display: grid;
        gap: var(--space-6);
        margin: var(--space-4) 0;
      }

      .post-card {
        display: grid;
        grid-template-columns: auto 1fr;
        gap: var(--space-4);
        padding: var(--space-6);
        background: var(--color-surface);
        border: 1px solid var(--color-gray-200);
        border-radius: var(--radius-lg);
        transition: all var(--duration-fast) var(--easing-default);
      }

      .post-card:hover {
        border-color: oklch(55% 0.24 var(--tag-hue));
        box-shadow: var(--shadow-md);
        transform: translateY(-2px);
      }

      .post-link {
        text-decoration: none;
        color: inherit;
        display: block;
      }

      .post-link:hover .post-title {
        color: oklch(55% 0.24 var(--tag-hue));
      }

      .post-date {
        color: var(--color-text-secondary);
        font-size: var(--font-size-sm);
        white-space: nowrap;
        padding-top: var(--space-1);
      }

      .post-content {
        min-width: 0;
      }

      .post-title {
        font-size: var(--font-size-lg);
        font-weight: var(--font-weight-semibold);
        color: var(--color-text-primary);
        margin: 0 0 var(--space-2) 0;
        line-height: var(--line-height-snug);
        transition: color var(--duration-fast) var(--easing-default);
      }

      .post-description {
        color: var(--color-text-secondary);
        font-size: var(--font-size-sm);
        line-height: var(--line-height-relaxed);
        margin-bottom: var(--space-3);
      }

      .post-tags {
        display: flex;
        flex-wrap: wrap;
        gap: var(--space-1);
        align-items: center;
        line-height: 1;
      }

      .empty-state {
        text-align: center;
        padding: var(--space-12) var(--space-4);
        color: var(--color-text-secondary);
      }

      .empty-state h2 {
        font-size: var(--font-size-2xl);
        margin-bottom: var(--space-2);
        color: var(--color-text-primary);
      }

      /* レスポンシブ対応 */
      @media (max-width: 768px) {
        .tag-page-container {
          margin: 0 auto var(--space-4);
          padding: 0 var(--space-2) var(--space-2);
        }

        .page-title {
          font-size: var(--font-size-2xl);
          flex-direction: column;
          text-align: center;
        }

        .page-meta {
          flex-direction: column;
          gap: var(--space-2);
        }

        .post-card {
          grid-template-columns: 1fr;
          gap: var(--space-3);
          padding: var(--space-4);
        }

        .post-date {
          order: -1;
          white-space: normal;
        }

      }

      /* ダークモード対応 */
      html.dark .page-header {
        border-bottom-color: var(--color-gray-700);
      }

      html.dark .posts-section h2 {
        border-bottom-color: var(--color-gray-700);
      }

      html.dark .post-card {
        background: var(--color-gray-800);
        border-color: var(--color-gray-700);
      }

      html.dark .post-card:hover {
        border-color: oklch(65% 0.20 var(--tag-hue));
        box-shadow: var(--shadow-lg);
      }
    </style>
  </head>

  <body>
    <Header />
    <main style="view-transition-name: main-content;">
      <div class="tag-page-container">
        <!-- パンくずナビゲーション -->
        <Breadcrumb items={breadcrumbItems} />

        <!-- ページヘッダー -->
        <header class="page-header">
          <h1 class="page-title">
            <span class="tag-icon">#</span>
            {tagName}
          </h1>
          
          <div class="page-meta">
            <div class="meta-item">
              <strong>{sortedPosts.length}</strong>{t('tags.posts')}
            </div>
            {isHierarchical && (
              <div class="meta-item">
                {t('tags.hierarchicalLevel').replace('{level}', String(tag.level + 1))}
              </div>
            )}
            {relatedTags.length > 1 && (
              <div class="meta-item">
                {t('tags.relatedTags').replace('{count}', String(relatedTags.length))}
              </div>
            )}
          </div>
        </header>

        <!-- 子タグ一覧 -->
        {childTags.length > 0 && (
          <section class="child-tags">
            <h2>{t('tags.subTags')}</h2>
            <div class="child-tags-list">
              {childTags.map(childTag => (
                <TagBadge
                  tag={childTag.name}
                  href={`/tags/${childTag.name.toLowerCase()}/`}
                  count={childTag.count}
                />
              ))}
            </div>
          </section>
        )}

        <!-- 記事一覧 -->
        <section class="posts-section">
          <h2>{t('tags.postList')}</h2>
          
          {sortedPosts.length > 0 ? (
            <div class="posts-grid">
              {sortedPosts.map((post) => (
                <div class="post-card">
                  <div class="post-date">
                    <FormattedDate date={post.data.published} />
                  </div>
                  <div class="post-content">
                    <a href={`/blog/${removeDatePrefix(post.id)}/`} class="post-link">
                      <h3 class="post-title">{post.data.title}</h3>
                      <p class="post-description">{post.data.description}</p>
                    </a>
                    {post.data.tags && post.data.tags.length > 0 && (
                      <div class="post-tags">
                        {post.data.tags.map(postTag => (
                          <TagBadge
                            tag={postTag}
                            href={`/tags/${postTag.toLowerCase()}/`}
                          />
                        ))}
                      </div>
                    )}
                  </div>
                </div>
              ))}
            </div>
          ) : (
            <div class="empty-state">
              <h2>{t('tags.noPostsFound')}</h2>
              <p>{t('tags.noPostsFoundDesc')}</p>
            </div>
          )}
        </section>
      </div>
    </main>
    <Footer />
  </body>
</html>