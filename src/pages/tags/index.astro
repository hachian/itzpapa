---
/**
 * タグ一覧ページ
 * 全ブログ記事のタグを収集して表示
 */

import { getCollection } from 'astro:content';
import BaseHead from '../../components/BaseHead.astro';
import Breadcrumb from '../../components/Breadcrumb.astro';
import Header from '../../components/Header.astro';
import Footer from '../../components/Footer.astro';
import TagBadge from '../../components/TagBadge.astro';
import TagTree from '../../components/TagTree.astro';
import { TagService } from '../../utils/tag/service';
import { siteConfig } from '../../../site.config';
import { t, getLanguage } from '../../i18n';

// 機能フラグを取得
const { features } = siteConfig;
const showTagCloud = features.tagCloud;

// 全ブログ記事を取得（本番環境ではdraft記事を除外）
const posts = await getCollection('blog', ({ data }) => {
  return import.meta.env.PROD ? data.draft !== true : true;
});

// タグサービスを使ってタグ情報を収集
const tagService = new TagService();

// 各記事のタグを収集
posts.forEach(post => {
  const frontmatterTags = post.data.tags || [];
  // TODO: インラインタグの収集は後で実装
  const inlineTags: string[] = [];
  
  tagService.addPostTags(
    post.id,
    frontmatterTags,
    inlineTags
  );
});

// タグを使用頻度順でソート
const allTags = tagService.getMostUsedTags(100); // 最大100個のタグを表示
const tagStatistics = tagService.getTagStatistics();

// 階層構造を取得
const hierarchy = tagService.getTagHierarchy();

// 階層タグ（子を持つルートタグ）とフラットタグを分離
const hierarchicalRootTags: string[] = [];
const flatTags: typeof allTags = [];

// ルートレベルのタグを分類
Object.entries(hierarchy).forEach(([tagName, { children }]) => {
  // 子を持つタグは階層タグ
  if (children && Object.keys(children).length > 0) {
    hierarchicalRootTags.push(tagName);
  }
});

// 全タグから階層タグとその子孫を除外したものがフラットタグ
allTags.forEach(tag => {
  // 階層タグのルートでない、かつスラッシュを含まない（子タグでない）
  const isHierarchicalRoot = hierarchicalRootTags.includes(tag.name);
  const isChildTag = tag.name.includes('/');

  if (!isHierarchicalRoot && !isChildTag) {
    flatTags.push(tag);
  }
});

// 階層タグのみを含むhierarchyを作成
const hierarchicalOnlyHierarchy: typeof hierarchy = {};
hierarchicalRootTags.forEach(tagName => {
  if (hierarchy[tagName]) {
    hierarchicalOnlyHierarchy[tagName] = hierarchy[tagName];
  }
});

// ページメタデータ
const tagsTitle = t('tags.title');
const tagsAriaLabel = t('tags.ariaLabel');
const lang = getLanguage();
const pageDescription = lang === 'ja'
  ? `${tagStatistics.totalTags}個のタグで記事を分類しています。`
  : `Organizing articles with ${tagStatistics.totalTags} tags.`;
---

<html lang={lang}>
  <head>
    <BaseHead title={tagsTitle} description={pageDescription} />
    <style>
      .tags-container {
        width: var(--content-max-width);
        max-width: calc(100% - 2em);
        margin: var(--space-2) auto var(--space-8);
        padding: 0 var(--space-4) var(--space-4);
      }

      .page-header {
        text-align: center;
        margin-bottom: var(--space-8);
        padding-bottom: var(--space-4);
        border-bottom: 2px solid var(--color-gray-200);
      }

      .page-title {
        font-size: var(--font-size-4xl);
        font-weight: var(--font-weight-bold);
        color: var(--color-text-primary);
        margin: 0 0 var(--space-2) 0;
      }

      .page-description {
        font-size: var(--font-size-lg);
        color: var(--color-text-secondary);
        margin: 0;
      }

      .tags-stats {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: var(--space-4);
        margin-bottom: var(--space-8);
        padding: var(--space-4);
        background-color: var(--color-gray-100);
        border-radius: var(--radius-lg);
      }

      .stat-item {
        text-align: center;
      }

      .stat-number {
        font-size: var(--font-size-3xl);
        font-weight: var(--font-weight-bold);
        color: var(--color-accent);
        display: block;
      }

      .stat-label {
        font-size: var(--font-size-sm);
        color: var(--color-text-secondary);
        margin-top: var(--space-1);
      }

      .empty-state {
        text-align: center;
        padding: var(--space-12) var(--space-4);
        color: var(--color-text-secondary);
      }

      .empty-state h2 {
        font-size: var(--font-size-2xl);
        margin-bottom: var(--space-2);
      }

      .tree-section {
        margin: var(--space-8) 0;
        padding: var(--space-6);
        background: var(--color-surface);
        border-radius: var(--radius-xl);
        border: 1px solid var(--color-gray-200);
      }

      .section-title {
        font-size: var(--font-size-2xl);
        font-weight: var(--font-weight-semibold);
        color: var(--color-text-primary);
        margin: 0 0 var(--space-4) 0;
        padding-bottom: var(--space-2);
        border-bottom: 2px solid var(--color-primary-200);
      }

      /* フラットタグをツリースタイルで表示 */
      .flat-tags-tree {
        font-family: var(--font-mono, 'Monaco', 'Consolas', monospace);
        font-size: 0.9rem;
        line-height: 1.4;
        background: var(--tree-bg, oklch(100% 0 0));
        border: 1px solid var(--tree-border, oklch(92% 0.010 280));
        border-radius: 8px;
        padding: 1rem;
      }

      .flat-tags-tree .tree-node {
        display: block;
        margin: 0;
        margin-bottom: 0.125rem;
      }

      .flat-tags-tree .tree-node-content {
        display: flex;
        align-items: center;
        padding: 0.25rem 0;
        border-radius: 4px;
        transition: background-color 0.15s ease;
        min-height: 2rem;
      }

      .flat-tags-tree .tree-node-content:hover {
        background-color: var(--tree-hover-bg, oklch(96% 0.008 280 / 0.5));
      }

      .flat-tags-tree .tree-icon {
        display: flex;
        align-items: center;
        justify-content: center;
        width: 1.5rem;
        height: 1.5rem;
        color: var(--color-text-secondary, oklch(55% 0.015 280));
        flex-shrink: 0;
        margin-right: 0.5rem;
      }

      .flat-tags-tree .tree-tag {
        flex: 1;
        min-width: 0;
      }

      .flat-tags-tree .tree-tag :global(.tree-tag-badge) {
        font-size: 0.85rem;
        padding: 0.15rem 0.5rem;
        margin: 0;
      }

      /* ダークモード - デザイントークンに統一 */
      html.dark .flat-tags-tree {
        background: var(--tree-bg);
        border-color: var(--tree-border);
      }

      html.dark .flat-tags-tree .tree-node-content:hover {
        background-color: var(--tree-hover-bg);
      }

      /* レスポンシブ対応 */
      @media (max-width: 768px) {
        .tags-container {
          margin: 0 auto var(--space-4);
          padding: 0 var(--space-2) var(--space-2);
        }

        .page-title {
          font-size: var(--font-size-2xl);
        }

        .tags-stats {
          grid-template-columns: repeat(2, 1fr);
          gap: var(--space-2);
          padding: var(--space-3);
        }

        .stat-number {
          font-size: var(--font-size-2xl);
        }
      }

      /* ダークモード対応 */
      html.dark .tree-section {
        background: var(--color-gray-800);
        border-color: var(--color-gray-700);
      }

      html.dark .tags-stats {
        background-color: var(--color-gray-800);
      }

      html.dark .page-header {
        border-bottom-color: var(--color-gray-700);
      }

      html.dark .section-title {
        border-bottom-color: var(--color-primary-700);
      }
    </style>
  </head>

  <body>
    <Header />
    <main style="view-transition-name: main-content;">
      <div class="tags-container">
        <Breadcrumb items={[
          { label: t('breadcrumb.home'), href: '/' },
          { label: t('breadcrumb.tags') }
        ]} />
        <header class="page-header">
          <h1 class="page-title">{tagsTitle}</h1>
          <p class="page-description">{pageDescription}</p>
        </header>

        {showTagCloud ? (
          allTags.length > 0 ? (
            <>
              <!-- 統計情報 -->
              <section class="tags-stats">
                <div class="stat-item">
                  <span class="stat-number">{tagStatistics.totalTags}</span>
                  <div class="stat-label">{t('tags.totalTags')}</div>
                </div>
                <div class="stat-item">
                  <span class="stat-number">{posts.length}</span>
                  <div class="stat-label">{t('tags.totalPosts')}</div>
                </div>
                <div class="stat-item">
                  <span class="stat-number">{allTags[0]?.count || 0}</span>
                  <div class="stat-label">{t('tags.maxUsage')}</div>
                </div>
              </section>

              {/* 階層タグセクション - 階層タグがある場合のみ表示 */}
              {hierarchicalRootTags.length > 0 && (
                <section class="tree-section">
                  <h2 class="section-title">{t('tags.hierarchical')}</h2>
                  <TagTree
                    hierarchy={hierarchicalOnlyHierarchy}
                    showCount={true}
                    expandAll={false}
                    initialDisplayLevel={0}
                    className="tags-tree"
                  />
                </section>
              )}

              {/* フラットタグセクション */}
              {flatTags.length > 0 && (
                <section class="tree-section">
                  <h2 class="section-title">{t('tags.flat')}</h2>
                  <div class="flat-tags-tree" role="tree" aria-label={tagsAriaLabel}>
                    {flatTags.map(tag => (
                      <div class="tree-node leaf-node" role="treeitem">
                        <div class="tree-node-content">
                          <div class="tree-icon" aria-hidden="true">
                            <svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor">
                              <path d="M2 1.75C2 .784 2.784 0 3.75 0h6.586c.464 0 .909.184 1.237.513l2.914 2.914c.329.328.513.773.513 1.237v9.586A1.75 1.75 0 0 1 13.25 16h-9.5A1.75 1.75 0 0 1 2 14.25Zm1.75-.25a.25.25 0 0 0-.25.25v12.5c0 .138.112.25.25.25h9.5a.25.25 0 0 0 .25-.25V6h-2.75A1.75 1.75 0 0 1 9 4.25V1.5Zm6.75.062V4.25c0 .138.112.25.25.25h2.688l-.011-.013-2.914-2.914-.013-.011Z"/>
                            </svg>
                          </div>
                          <div class="tree-tag">
                            <TagBadge
                              tag={tag.name}
                              href={`/tags/${tag.name.toLowerCase()}/`}
                              count={tag.count}
                              className="tree-tag-badge"
                            />
                          </div>
                        </div>
                      </div>
                    ))}
                  </div>
                </section>
              )}

            </>
          ) : (
            <!-- 空の状態 -->
            <section class="empty-state">
              <h2>{t('tags.notFound')}</h2>
              <p>{t('tags.notFoundDesc')}</p>
            </section>
          )
        ) : (
          <!-- タグクラウド無効 -->
          <section class="empty-state">
            <h2>{t('tags.disabled')}</h2>
            <p>{t('tags.disabledDesc')}</p>
          </section>
        )}
      </div>
    </main>
    <Footer />

  </body>
</html>