---
/**
 * カテゴリ別記事一覧ページ
 * 特定のカテゴリに属する記事一覧を表示
 */

import { getCollection } from 'astro:content';
import BaseHead from '../../components/BaseHead.astro';
import Breadcrumb from '../../components/Breadcrumb.astro';
import Header from '../../components/Header.astro';
import Footer from '../../components/Footer.astro';
import FormattedDate from '../../components/FormattedDate.astro';
import CategoryBadge from '../../components/CategoryBadge.astro';
import TagBadge from '../../components/TagBadge.astro';
import { t, getLanguage } from '../../i18n';

export async function getStaticPaths() {
  // 全ブログ記事を取得（本番環境ではdraft記事を除外）
  const posts = await getCollection('blog', ({ data }) => {
    return import.meta.env.PROD ? data.draft !== true : true;
  });

  // カテゴリごとにグループ化
  const categories = new Map<string, typeof posts>();
  posts.forEach(post => {
    const category = post.data.category;
    if (category && category.trim() !== '') {
      if (!categories.has(category)) {
        categories.set(category, []);
      }
      categories.get(category)!.push(post);
    }
  });

  return Array.from(categories.entries()).map(([category, categoryPosts]) => ({
    params: { name: category.toLowerCase() },
    props: {
      category,
      posts: categoryPosts.sort(
        (a, b) => b.data.published.valueOf() - a.data.published.valueOf()
      )
    }
  }));
}

interface Props {
  category: string;
  posts: Awaited<ReturnType<typeof getCollection<'blog'>>>;
}

const { category, posts } = Astro.props;

// パンくずリスト用のアイテム配列を構築
const breadcrumbItems = [
  { label: t('breadcrumb.home'), href: '/' },
  { label: t('breadcrumb.category'), href: '/category/' },
  { label: category }
];

// ページメタデータと翻訳
const lang = getLanguage();
const pageTitle = lang === 'ja'
  ? `${category} のカテゴリ記事`
  : `Category: ${category}`;
const pageDescription = lang === 'ja'
  ? `${category}カテゴリの${posts.length}件の記事一覧`
  : `${posts.length} posts in category ${category}`;
---

<html lang={lang}>
  <head>
    <BaseHead title={pageTitle} description={pageDescription} />
    <style>
      /* カテゴリ用の色相シフト（+20°）を定義 */
      :root {
        --category-hue: calc(var(--primary-hue) + 20);
      }

      .category-page-container {
        width: var(--content-max-width);
        max-width: calc(100% - 2em);
        margin: var(--space-2) auto var(--space-8);
        padding: 0 var(--space-4) var(--space-4);
      }

      .page-header {
        margin-bottom: var(--space-8);
        padding-bottom: var(--space-4);
        border-bottom: 2px solid var(--color-gray-200);
      }

      .page-title {
        font-size: var(--font-size-4xl);
        font-weight: var(--font-weight-bold);
        color: var(--color-text-primary);
        margin: 0 0 var(--space-2) 0;
        display: flex;
        align-items: center;
        gap: var(--space-2);
      }

      .category-icon {
        font-size: var(--font-size-3xl);
        color: oklch(55% 0.24 var(--category-hue));
      }

      .page-meta {
        display: flex;
        gap: var(--space-8);
        margin-bottom: var(--space-4);
        font-size: var(--font-size-sm);
        color: var(--color-text-secondary);
      }

      .meta-item {
        display: flex;
        align-items: center;
        gap: var(--space-1);
      }

      .posts-section h2 {
        font-size: var(--font-size-2xl);
        margin-bottom: var(--space-4);
        color: var(--color-text-primary);
        border-bottom: 1px solid var(--color-gray-200);
        padding-bottom: var(--space-2);
      }

      .posts-grid {
        display: grid;
        gap: var(--space-6);
        margin: var(--space-4) 0;
      }

      .post-card {
        display: grid;
        grid-template-columns: auto 1fr;
        gap: var(--space-4);
        padding: var(--space-6);
        background: var(--color-surface);
        border: 1px solid var(--color-gray-200);
        border-radius: var(--radius-lg);
        transition: all var(--duration-fast) var(--easing-default);
      }

      .post-card:hover {
        border-color: oklch(55% 0.24 var(--category-hue));
        box-shadow: var(--shadow-md);
        transform: translateY(-2px);
      }

      .post-link {
        text-decoration: none;
        color: inherit;
        display: block;
      }

      .post-link:hover .post-title {
        color: oklch(55% 0.24 var(--category-hue));
      }

      .post-date {
        color: var(--color-text-secondary);
        font-size: var(--font-size-sm);
        white-space: nowrap;
        padding-top: var(--space-1);
      }

      .post-content {
        min-width: 0;
      }

      .post-title {
        font-size: var(--font-size-lg);
        font-weight: var(--font-weight-semibold);
        color: var(--color-text-primary);
        margin: 0 0 var(--space-2) 0;
        line-height: var(--line-height-snug);
        transition: color var(--duration-fast) var(--easing-default);
      }

      .post-description {
        color: var(--color-text-secondary);
        font-size: var(--font-size-sm);
        line-height: var(--line-height-relaxed);
        margin-bottom: var(--space-3);
      }

      .post-tags {
        display: flex;
        flex-wrap: wrap;
        gap: var(--space-1);
        align-items: center;
        line-height: 1;
      }

      .empty-state {
        text-align: center;
        padding: var(--space-12) var(--space-4);
        color: var(--color-text-secondary);
      }

      .empty-state h2 {
        font-size: var(--font-size-2xl);
        margin-bottom: var(--space-2);
        color: var(--color-text-primary);
      }

      .back-link {
        display: inline-flex;
        align-items: center;
        gap: var(--space-2);
        margin-top: var(--space-8);
        padding: var(--space-3) var(--space-4);
        background: var(--color-surface);
        border: 1px solid var(--color-gray-200);
        border-radius: var(--radius-lg);
        color: var(--color-text-secondary);
        text-decoration: none;
        font-size: var(--font-size-sm);
        transition: all var(--duration-fast) var(--easing-default);
      }

      .back-link:hover {
        border-color: oklch(55% 0.24 var(--category-hue));
        color: oklch(55% 0.24 var(--category-hue));
      }

      /* レスポンシブ対応 */
      @media (max-width: 768px) {
        .category-page-container {
          margin: 0 auto var(--space-4);
          padding: 0 var(--space-2) var(--space-2);
        }

        .page-title {
          font-size: var(--font-size-2xl);
          flex-direction: column;
          text-align: center;
        }

        .page-meta {
          flex-direction: column;
          gap: var(--space-2);
        }

        .post-card {
          grid-template-columns: 1fr;
          gap: var(--space-3);
          padding: var(--space-4);
        }

        .post-date {
          order: -1;
          white-space: normal;
        }
      }

      /* ダークモード対応 */
      html.dark .page-header {
        border-bottom-color: var(--color-gray-700);
      }

      html.dark .posts-section h2 {
        border-bottom-color: var(--color-gray-700);
      }

      html.dark .post-card {
        background: var(--color-gray-800);
        border-color: var(--color-gray-700);
      }

      html.dark .post-card:hover {
        border-color: oklch(65% 0.20 var(--category-hue));
        box-shadow: var(--shadow-lg);
      }

      html.dark .back-link {
        background: var(--color-gray-800);
        border-color: var(--color-gray-700);
      }

      html.dark .back-link:hover {
        border-color: oklch(65% 0.20 var(--category-hue));
        color: oklch(65% 0.20 var(--category-hue));
      }
    </style>
  </head>

  <body>
    <Header />
    <main style="view-transition-name: main-content;">
      <div class="category-page-container">
        <!-- パンくずナビゲーション -->
        <Breadcrumb items={breadcrumbItems} />

        <!-- ページヘッダー -->
        <header class="page-header">
          <h1 class="page-title">
            <CategoryBadge category={category} />
          </h1>

          <div class="page-meta">
            <div class="meta-item">
              <strong>{posts.length}</strong>{t('category.posts')}
            </div>
          </div>
        </header>

        <!-- 記事一覧 -->
        <section class="posts-section">
          {posts.length > 0 ? (
            <div class="posts-grid">
              {posts.map((post) => (
                <div class="post-card">
                  <div class="post-date">
                    <FormattedDate date={post.data.published} />
                  </div>
                  <div class="post-content">
                    <a href={`/blog/${post.id}/`} class="post-link">
                      <h3 class="post-title">{post.data.title}</h3>
                      <p class="post-description">{post.data.description}</p>
                    </a>
                    {post.data.tags && post.data.tags.length > 0 && (
                      <div class="post-tags">
                        {post.data.tags.map(postTag => (
                          <TagBadge
                            tag={postTag}
                            href={`/tags/${postTag.toLowerCase()}/`}
                          />
                        ))}
                      </div>
                    )}
                  </div>
                </div>
              ))}
            </div>
          ) : (
            <div class="empty-state">
              <h2>{t('category.noPostsFound')}</h2>
              <p>{t('category.noPostsFoundDesc')}</p>
            </div>
          )}
        </section>

        <!-- カテゴリ一覧へのリンク -->
        <a href="/category/" class="back-link">
          <span aria-hidden="true">&larr;</span>
          {t('category.backToList')}
        </a>
      </div>
    </main>
    <Footer />
  </body>
</html>
