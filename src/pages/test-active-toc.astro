---
import TableOfContentsWithActive from '../components/TableOfContentsWithActive.astro';
import '../styles/table-of-contents.css';
import '../styles/design-tokens.css';

// テスト用の見出しデータ（長いページ用）
const testHeadings = [
  { depth: 2, text: "セクション1", slug: "section-1" },
  { depth: 3, text: "サブセクション1.1", slug: "subsection-1-1" },
  { depth: 3, text: "サブセクション1.2", slug: "subsection-1-2" },
  { depth: 2, text: "セクション2", slug: "section-2" },
  { depth: 3, text: "サブセクション2.1", slug: "subsection-2-1" },
  { depth: 2, text: "セクション3", slug: "section-3" },
  { depth: 2, text: "セクション4", slug: "section-4" },
  { depth: 3, text: "サブセクション4.1", slug: "subsection-4-1" },
  { depth: 2, text: "セクション5", slug: "section-5" },
];
---

<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>アクティブ状態管理テスト</title>
  <style>
    body {
      font-family: system-ui, -apple-system, sans-serif;
      margin: 0;
      padding: 0;
    }

    .test-header {
      background: var(--color-gray-100);
      padding: 1rem;
      text-align: center;
      position: sticky;
      top: 0;
      z-index: 100;
      border-bottom: 2px solid var(--color-gray-200);
    }

    .blog-layout-with-toc {
      display: grid;
      grid-template-columns: 1fr 300px;
      gap: 2rem;
      max-width: 1200px;
      margin: 0 auto;
      padding: 2rem;
    }

    .content {
      padding: 1rem;
    }

    .content section {
      min-height: 600px;
      padding: 2rem;
      margin-bottom: 2rem;
      border: 1px solid var(--color-gray-200);
      border-radius: 8px;
      background: linear-gradient(135deg, var(--color-gray-100) 0%, var(--color-surface) 100%);
    }

    .content h2 {
      color: var(--color-text-primary);
      border-bottom: 2px solid var(--color-primary-600);
      padding-bottom: 0.5rem;
    }

    .content h3 {
      color: var(--color-text-secondary);
      margin-left: 1rem;
    }

    .debug-info {
      position: fixed;
      bottom: 10px;
      left: 10px;
      background: rgba(0, 0, 0, 0.8);
      color: white;
      padding: 10px;
      border-radius: 5px;
      font-size: 12px;
      z-index: 9999;
    }

    @media (max-width: 768px) {
      .blog-layout-with-toc {
        grid-template-columns: 1fr;
      }
    }
  </style>
</head>
<body>
  <div class="test-header">
    <h1>アクティブ状態管理機能テスト</h1>
    <p>スクロールすると、現在表示中のセクションに対応する目次項目がハイライトされます</p>
  </div>

  <div class="blog-layout-with-toc">
    <div class="content">
      <section>
        <h2 id="section-1">セクション1</h2>
        <p>これはセクション1の内容です。Intersection Observer APIを使用して、このセクションが表示されると目次の対応する項目がアクティブになります。</p>

        <h3 id="subsection-1-1">サブセクション1.1</h3>
        <p>サブセクションの内容です。階層構造も正しく処理されます。</p>
        <p>Lorem ipsum dolor sit amet, consectetur adipiscing elit.</p>

        <h3 id="subsection-1-2">サブセクション1.2</h3>
        <p>もう1つのサブセクションです。</p>
        <p>Sed do eiusmod tempor incididunt ut labore et dolore magna aliqua.</p>
      </section>

      <section>
        <h2 id="section-2">セクション2</h2>
        <p>セクション2の内容です。スクロールしてこのセクションが表示されると、目次のアクティブ項目が切り替わります。</p>

        <h3 id="subsection-2-1">サブセクション2.1</h3>
        <p>このサブセクションも監視対象です。</p>
        <p>Ut enim ad minim veniam, quis nostrud exercitation ullamco laboris.</p>
      </section>

      <section>
        <h2 id="section-3">セクション3</h2>
        <p>セクション3です。パフォーマンスを最適化するため、Intersection Observerを使用しています。</p>
        <p>Duis aute irure dolor in reprehenderit in voluptate velit esse cillum dolore eu fugiat nulla pariatur.</p>
        <p>複数の段落がある場合でも、正しく動作します。</p>
      </section>

      <section>
        <h2 id="section-4">セクション4</h2>
        <p>セクション4の開始です。</p>

        <h3 id="subsection-4-1">サブセクション4.1</h3>
        <p>ネストされた見出しも適切に処理されます。</p>
        <p>Excepteur sint occaecat cupidatat non proident, sunt in culpa qui officia deserunt mollit anim id est laborum.</p>
      </section>

      <section>
        <h2 id="section-5">セクション5</h2>
        <p>最後のセクションです。ページの最下部でも正しくアクティブ状態が管理されます。</p>
        <p>Lorem ipsum dolor sit amet, consectetur adipiscing elit, sed do eiusmod tempor incididunt ut labore et dolore magna aliqua.</p>
        <p>Ut enim ad minim veniam, quis nostrud exercitation ullamco laboris nisi ut aliquip ex ea commodo consequat.</p>
        <p>最後まで読んでいただきありがとうございます！</p>
      </section>
    </div>

    <aside class="toc-sidebar">
      <TableOfContentsWithActive headings={testHeadings} />
    </aside>
  </div>

  <div class="debug-info">
    <div>Scroll Position: <span id="scroll-pos">0</span>px</div>
    <div>Active Section: <span id="active-section">-</span></div>
  </div>

  <script>
    // デバッグ情報の表示
    function updateDebugInfo() {
      const scrollPos = window.scrollY;
      document.getElementById('scroll-pos').textContent = Math.round(scrollPos);

      const activeLink = document.querySelector('.toc-link.active');
      if (activeLink) {
        document.getElementById('active-section').textContent = activeLink.textContent;
      }
    }

    window.addEventListener('scroll', updateDebugInfo);
    window.addEventListener('DOMContentLoaded', updateDebugInfo);

    // アクティブ状態の変更を監視
    const observer = new MutationObserver(() => {
      updateDebugInfo();
    });

    document.addEventListener('DOMContentLoaded', () => {
      const tocLinks = document.querySelectorAll('.toc-link');
      tocLinks.forEach(link => {
        observer.observe(link, { attributes: true, attributeFilter: ['class'] });
      });
    });
  </script>
</body>
</html>