# Implementation Plan

## Tasks

- [x] 1. 設定管理モジュールの実装
- [x] 1.1 (P) 外部画像ホスティング設定の型定義と読み込み機能
  - プロバイダー種別（S3/R2/custom）、ベースURL、バケット名などの設定オプションを定義
  - 設定ファイルからオプションを読み込み、デフォルト値とマージする機能
  - 設定値のバリデーション（URL形式、必須項目チェック）
  - _Requirements: 1.1, 1.3, 4.2, 5.1, 5.3_

- [x] 1.2 (P) 環境変数からの認証情報読み取り機能
  - S3用の環境変数（AWS_ACCESS_KEY_ID、AWS_SECRET_ACCESS_KEY）の読み取り
  - R2用の環境変数（R2_ACCESS_KEY_ID、R2_SECRET_ACCESS_KEY、R2_ACCOUNT_ID）の読み取り
  - 認証情報未設定時のnull返却と警告メッセージ出力
  - 設定ファイルには認証情報を含めない設計の徹底
  - _Requirements: 5.2, 6.2, 7.1, 7.2_

- [x] 1.3 設定モジュールの単体テスト
  - デフォルト値マージのテスト
  - バリデーションエラーケースのテスト
  - 環境変数読み取りのテスト（モック使用）
  - _Requirements: 1.1, 5.1, 5.2, 7.1_

- [x] 2. S3/R2アップロードサービスの実装
- [x] 2.1 S3クライアント生成機能
  - プロバイダー（S3/R2）に応じたエンドポイントURL設定
  - 認証情報を使用したクライアント初期化
  - R2用のS3互換エンドポイント構築
  - _Requirements: 5.1, 6.1_

- [x] 2.2 画像アップロード機能
  - PutObjectコマンドによるファイルアップロード
  - Content-TypeとCache-Controlヘッダーの設定
  - 5MB以上のファイルに対するマルチパートアップロード対応
  - _Requirements: 6.1_

- [x] 2.3 差分チェック機能
  - HeadObjectによるオブジェクト存在確認
  - ETag比較による変更検出
  - 変更なしファイルのスキップ処理
  - _Requirements: 6.3_

- [x] 2.4 アップロードサービスの単体テスト
  - モックS3クライアントを使用したアップロードテスト
  - 差分チェックロジックのテスト
  - エラーハンドリングのテスト
  - _Requirements: 6.1, 6.3_

- [x] 3. Remarkプラグインの実装
- [x] 3.1 画像ノード検出と変換ロジック
  - Markdown AST内の画像ノードを走査
  - 相対パス（./、../）の画像URLを検出
  - ベースURLとスラッグを組み合わせた外部URLへの変換
  - _Requirements: 1.2, 2.1_

- [x] 3.2 変換条件の判定機能
  - 絶対URL（http/https）のスキップ処理
  - フロントマターによる記事単位の制御
  - 開発モード時のローカルパス維持オプション
  - _Requirements: 1.4, 2.2, 4.3_

- [x] 3.3 フォールバック動作の実装
  - 外部ホスティング無効時の従来動作維持
  - 設定可能なフォールバック動作（ローカルパス使用）
  - _Requirements: 1.3, 2.3_

- [x] 3.4 Remarkプラグインの単体テスト
  - 相対パス画像の変換テスト
  - 絶対URL維持のテスト
  - フロントマター制御のテスト
  - WikiLink画像記法との連携テスト
  - _Requirements: 2.1, 2.2, 2.3_

- [x] 4. Astroインテグレーションの実装
- [x] 4.1 インテグレーション基本構造
  - AstroIntegration形式のファクトリ関数作成
  - astro:config:setupフックでの設定拡張
  - astro:build:doneフックの登録
  - _Requirements: 4.1_

- [x] 4.2 ビルド後の画像収集処理
  - distディレクトリ内の画像ファイル列挙
  - include/excludeパターンによるフィルタリング
  - 記事スラッグとファイルパスのマッピング
  - _Requirements: 6.5_

- [x] 4.3 画像アップロード実行処理
  - 認証情報の存在確認（未設定時はスキップ）
  - S3UploadServiceを使用した並列アップロード
  - 進捗状況のコンソール表示（アップロード中、スキップ、完了）
  - _Requirements: 6.1, 6.6, 7.3_

- [x] 4.4 画像削除とエラーハンドリング
  - アップロード完了後のdistからの画像ファイル削除
  - 外部ホスティング無効時の画像維持
  - アップロード失敗時の動作制御（failOnError設定）
  - _Requirements: 4.4, 4.5, 6.4_

- [x] 4.5 インテグレーションの統合テスト
  - モックS3クライアントでのアップロードフロー確認
  - 画像削除動作の確認
  - エラーハンドリングの確認
  - _Requirements: 4.4, 6.1, 6.4_

- [x] 5. astro.config.mjsへの統合
- [x] 5.1 インテグレーション登録とRemarkプラグイン追加
  - astro-image-hostingインテグレーションの登録
  - remark-image-external-hostingプラグインの追加（remark-wikilink後に配置）
  - 設定オプションの受け渡し
  - _Requirements: 4.1_

- [x] 5.2 環境変数テンプレートの作成
  - .env.exampleファイルの作成（S3/R2両対応）
  - 各環境変数の説明コメント追加
  - _Requirements: 7.1, 7.2_

- [x] 6. 動作確認とドキュメント整備
- [x] 6.1 ローカル環境での動作確認
  - 開発モードでのローカル画像表示確認
  - ビルド時の画像アップロード動作確認
  - dist出力からの画像除外確認
  - _Requirements: 4.1, 4.3, 4.4_

- [x] 6.2 外部ホスティング無効時の動作確認
  - 設定無効時の従来動作維持確認
  - 認証情報未設定時のスキップ動作確認
  - _Requirements: 1.3, 4.5, 7.3_

## Requirements Coverage

| Requirement | Tasks |
|-------------|-------|
| 1.1 | 1.1, 1.3 |
| 1.2 | 3.1 |
| 1.3 | 1.1, 3.3, 6.2 |
| 1.4 | 3.2 |
| 2.1 | 3.1, 3.4 |
| 2.2 | 3.2, 3.4 |
| 2.3 | 3.3, 3.4 |
| 3.1 | Astro標準対応（実装不要） |
| 3.2 | Astro標準対応（実装不要） |
| 3.3 | ブラウザ標準動作（実装不要） |
| 4.1 | 4.1, 5.1, 6.1 |
| 4.2 | 1.1 |
| 4.3 | 3.2, 6.1 |
| 4.4 | 4.4, 6.1 |
| 4.5 | 4.4, 6.2 |
| 5.1 | 1.1, 2.1 |
| 5.2 | 1.2 |
| 5.3 | 1.1 |
| 6.1 | 2.2, 4.3 |
| 6.2 | 1.2 |
| 6.3 | 2.3, 2.4 |
| 6.4 | 4.4, 4.5 |
| 6.5 | 4.2 |
| 6.6 | 4.3 |
| 7.1 | 1.2, 1.3, 5.2 |
| 7.2 | 1.2, 5.2 |
| 7.3 | 4.3, 6.2 |

## Notes

- **並列実行可能タスク**: 1.1と1.2は依存関係がなく並列実行可能
- **Requirement 3.x**: Astro標準機能および外部画像のブラウザ標準動作でカバーされるため、追加実装不要
- **テストタスク**: 各コンポーネントの単体テストと統合テストを含む
- **推奨実行順序**: 1 → 2 → 3 → 4 → 5 → 6
