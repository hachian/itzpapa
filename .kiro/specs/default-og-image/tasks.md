# Implementation Plan

## Tasks

- [x] 1. 依存関係とフォントのセットアップ
- [x] 1.1 satoriパッケージのインストールと日本語フォントファイルの配置
  - npmでsatoriパッケージを追加
  - Noto Sans JPのTTFファイル（Regular/Bold）を取得し、`src/assets/fonts/` に配置
  - `package.json` の依存関係が正しく更新されていることを確認
  - _Requirements: 5.2_

- [x] 2. フォント読み込み機能の実装
- [x] 2.1 フォントローダーユーティリティの作成
  - Noto Sans JP TTFファイルをBufferとして読み込む機能を実装
  - Regular（400）とBold（700）の両ウェイトに対応
  - Satori用のフォント設定オブジェクト形式で返却
  - フォントファイル欠落時は明確なエラーメッセージを出力
  - _Requirements: 5.1, 5.2, 5.3_

- [x] 3. 画像生成コア機能の実装
- [x] 3.1 OG画像テンプレートの作成
  - ベース画像（`itzpapa-light_16_9.png`）を背景に使用するJSXテンプレートを定義
  - タイトルテキストを画像中央に配置
  - 長文タイトルの自動改行処理を実装
  - 背景上でテキストが読みやすいよう半透明オーバーレイを追加
  - _Requirements: 2.1, 2.2, 2.3, 2.4_

- [x] 3.2 heroImageテンプレートの作成
  - ライトモード版（`itzpapa-light_16_9.png`）とダークモード版（`itzpapa-dark_16_9.png`）の両テンプレートを定義
  - OG画像テンプレートと同じタイトルスタイル（フォント、配置、コントラスト）を適用
  - 1020x510ピクセル（2:1比率）に対応したレイアウト
  - _Requirements: 6.2, 6.6_

- [x] 3.3 画像生成サービスの実装
  - SatoriでJSXテンプレートをSVGに変換する機能を実装
  - SharpでSVGをPNG形式に変換する機能を実装
  - OG画像（1200x630）とheroImage（1020x510）の両サイズに対応
  - タイトル長に応じたフォントサイズの動的調整
  - _Requirements: 1.1, 1.2, 1.3, 1.4, 6.1, 6.3_

- [x] 4. OG画像エンドポイントの実装
- [x] 4.1 (P) 記事用OG画像エンドポイントの作成
  - `/og/[...slug].png` パスで各記事のOG画像を提供するエンドポイントを作成
  - `getStaticPaths()` でブログ記事一覧を取得し、全スラッグを列挙
  - `prerender = true` でビルド時の静的生成を保証
  - 画像生成サービスを呼び出し、PNG形式でレスポンスを返却
  - _Requirements: 1.1, 3.1, 3.2_

- [x] 4.2 (P) デフォルトOG画像エンドポイントの作成
  - `/og/default.png` パスでサイト全体のデフォルトOG画像を提供
  - サイト名「itzpapa」とタグライン（サイト説明文）を表示
  - 記事用OG画像と同じデザインテーマを使用
  - _Requirements: 4.1, 4.2, 4.3_

- [x] 5. heroImageエンドポイントの実装
- [x] 5.1 (P) heroImage自動生成エンドポイントの作成
  - heroImageが未設定の記事のみを対象に画像を生成
  - `/hero/{slug}-light.png` と `/hero/{slug}-dark.png` の2つのパスで提供
  - ブログ記事コレクションから対象記事をフィルタリング
  - `prerender = true` でビルド時の静的生成を保証
  - _Requirements: 6.1, 6.2, 6.3, 6.5_

- [x] 6. 既存コンポーネントの統合
- [x] 6.1 BaseHeadコンポーネントのOG画像参照を更新
  - 記事ページでは `/og/{slug}.png` を参照するよう修正
  - 非記事ページでは `/og/default.png` を参照するよう修正
  - カスタムOG画像（Props.image）が指定されている場合は従来通り優先
  - 既存のフォールバックロジックを維持
  - _Requirements: 3.3, 3.4_

- [x] 6.2 BlogPostレイアウトのheroImage参照を更新
  - heroImage未設定時に生成された画像（`/hero/{slug}-light.png`, `/hero/{slug}-dark.png`）を参照
  - 既存のダークモード切り替えCSSを維持
  - カスタムheroImageが設定されている場合は従来通り表示
  - slugをpropsから取得できるよう対応
  - _Requirements: 6.4, 6.5_

- [x] 7. 動作検証とビルドテスト
- [x] 7.1 ビルド実行と生成画像の確認
  - `npm run build` を実行し、エラーなくビルドが完了することを確認
  - 生成された画像ファイル（`/og/*.png`, `/hero/*.png`）の存在を確認
  - 画像サイズ（OG: 1200x630、hero: 1020x510）が正しいことを検証
  - 日本語タイトルを含む記事のOG画像が正しく生成されていることを確認
  - _Requirements: 1.2, 1.3, 5.3, 6.3_

- [ ]* 7.2 ユニットテストの追加
  - 画像生成サービスのテスト（正常系、タイトル空文字、長文タイトル）
  - フォントローダーのテスト（読み込み成功、ファイル欠落時のエラー）
  - ライト/ダーク両テーマのheroImage生成テスト
  - _Requirements: 1.1, 5.1, 6.2_
