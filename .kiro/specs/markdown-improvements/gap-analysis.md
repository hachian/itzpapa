# Implementation Gap Analysis

## 概要

本ドキュメントは、`markdown-improvements`仕様の要件と既存コードベースとのギャップを分析し、実装アプローチの選択肢を提示します。

## 1. 現状調査

### 1.1 既存プラグイン構造

| プラグイン | ファイル | 行数 | 主な機能 |
|-----------|---------|------|---------|
| remark-wikilink | `src/plugins/remark-wikilink/index.js` | 183行 | WikiLink記法の解析、画像WikiLink対応 |
| remark-mark-highlight | `src/plugins/remark-mark-highlight/index.js` | 285行 | マークハイライト記法、LRUキャッシュ、セキュリティ対策 |
| remark-tags | `src/plugins/remark-tags/index.js` | 235行 | インラインタグ処理、階層タグ対応 |
| remark-callout | `src/plugins/remark-callout/index.js` | 193行 | Callout構文解析（remarkフェーズ） |
| rehype-callout | `src/plugins/rehype-callout/index.js` | 166行 | Callout HTML変換（rehypeフェーズ） |

### 1.2 プラグイン処理順序（astro.config.mjs）

```
1. remarkWikilink (priority: high)
2. remarkMarkHighlight (cache: true, securityMode: auto)
3. remarkTags (convertToLinks: true)
4. remarkCallout (maxNestingDepth: 3)
```

### 1.3 既存テスト構造

| テストファイル | 対象 | テストケース数 |
|--------------|------|--------------|
| `wikilink-test.js` | WikiLink | 40+ |
| `image-wikilink-test.js` | 画像WikiLink | 10+ |
| `table-wikilink-test.js` | テーブル内WikiLink | 10+ |
| `mark-highlight-plugin-test.js` | マークハイライト | 基本テスト |
| `mark-highlight-escape-test.js` | エスケープ処理 | エッジケース |
| `mark-highlight-advanced-test.js` | 高度なケース | ネスト等 |
| `task-103-integration.test.js` | 統合テスト | プラグイン連携 |
| `task-202-accessibility-simple.test.js` | アクセシビリティ | WCAG準拠 |
| `task-301-performance.test.js` | パフォーマンス | 処理速度 |
| `task-302-security-simple.test.js` | セキュリティ | XSS防止 |

### 1.4 テストインフラ

- **テストランナー**: `test/test-runner.js`（独自実装）
- **テストフレームワーク**: Node.js組み込みテストランナー（`node --test`）
- **NPMスクリプト**: `npm run test`（4スイート実行）
- **レポート出力**: `test/test-report.json`

## 2. 要件とのギャップ分析

### Requirement 1: WikiLinkプラグインの挙動改善

| 受入基準 | 現状 | ギャップ |
|---------|------|---------|
| 基本WikiLink変換 | ✅ 実装済み | なし |
| エイリアス対応 | ✅ 実装済み | なし |
| リンク切れスタイル | ⚠️ 未実装 | **Missing**: 存在チェック機能とCSSクラス |
| コードブロック除外 | ✅ 実装済み | なし |
| 日本語URLエンコード | ✅ 実装済み | なし |
| 画像WikiLink | ✅ 実装済み | なし |

### Requirement 2: マークハイライトプラグインの挙動改善

| 受入基準 | 現状 | ギャップ |
|---------|------|---------|
| 基本ハイライト変換 | ✅ 実装済み | なし |
| 複数行ハイライト | ⚠️ 部分的 | **Unknown**: 複数行にまたがるケースの動作確認が必要 |
| コードブロック除外 | ✅ 実装済み | なし |
| ネスト書式保持 | ✅ 実装済み | なし |
| 不正形式のハンドリング | ✅ 実装済み | なし |

### Requirement 3: Calloutプラグインの挙動改善

| 受入基準 | 現状 | ギャップ |
|---------|------|---------|
| 基本Callout変換 | ✅ 実装済み | なし |
| 折りたたみ対応 | ✅ 実装済み | なし |
| カスタムタイトル | ✅ 実装済み | なし |
| ネストCallout | ✅ 実装済み（maxNestingDepth: 3） | なし |
| 標準タイプ対応 | ✅ 7タイプ対応 | なし |

### Requirement 4: タグプラグインの挙動改善

| 受入基準 | 現状 | ギャップ |
|---------|------|---------|
| インラインタグ変換 | ✅ 実装済み | なし |
| 階層タグ対応 | ✅ 実装済み | なし |
| コードブロック除外 | ⚠️ 要確認 | **Unknown**: コードブロック内の除外ロジック確認が必要 |
| 日本語タグ | ✅ 実装済み | なし |
| 不正タグのスキップ | ✅ 実装済み | なし |

### Requirement 5: プラグインの単体テスト

| 受入基準 | 現状 | ギャップ |
|---------|------|---------|
| 各プラグインの単体テスト | ⚠️ 部分的 | **Missing**: Calloutの専用単体テストファイルがない |
| 正常系パターン網羅 | ⚠️ 部分的 | **Missing**: 一部プラグインでカバレッジ不足 |
| エッジケーステスト | ⚠️ 部分的 | **Missing**: 空入力、特殊文字の網羅的テスト |
| エラーハンドリングテスト | ⚠️ 部分的 | **Missing**: 異常系の体系的テスト |
| npm run test実行 | ✅ 実装済み | なし |

### Requirement 6: 統合テスト

| 受入基準 | 現状 | ギャップ |
|---------|------|---------|
| 複数記法混在 | ⚠️ 部分的 | **Missing**: `task-103-integration.test.js`は存在するが網羅性不足 |
| WikiLink+マークハイライト | ⚠️ 部分的 | 基本ケースのみ |
| Callout+WikiLink/タグ | ❌ 未実装 | **Missing**: Callout統合テストなし |
| コードブロック除外 | ✅ 基本テストあり | なし |
| 処理順序テスト | ⚠️ 部分的 | **Missing**: 体系的な順序検証なし |
| 競合・干渉テスト | ❌ 未実装 | **Missing**: `==`と`===`の競合テストなし |

### Requirement 7: E2Eテスト

| 受入基準 | 現状 | ギャップ |
|---------|------|---------|
| WikiLink href検証 | ❌ 未実装 | **Missing**: ビルド出力の検証なし |
| マークハイライトmark要素 | ❌ 未実装 | **Missing**: ビルド出力の検証なし |
| Callout DOM構造 | ❌ 未実装 | **Missing**: ビルド出力の検証なし |
| タグバッジリンク | ❌ 未実装 | **Missing**: ビルド出力の検証なし |

### Requirement 8: テストドキュメントとテストデータ

| 受入基準 | 現状 | ギャップ |
|---------|------|---------|
| サンプルMarkdownファイル | ⚠️ 部分的 | **Missing**: 体系的なテストフィクスチャディレクトリなし |
| エッジケースファイル | ⚠️ 部分的 | 散在している |
| 日本語コンテンツ | ✅ テスト内に存在 | なし |
| 期待出力 | ❌ 未実装 | **Missing**: expected outputファイルなし |
| README | ✅ `test/README.md`存在 | 更新が必要 |

## 3. 実装アプローチオプション

### Option A: 既存コンポーネントの拡張

**対象**: プラグイン改善（Req 1-4）

**拡張内容**:
- `remark-wikilink`: リンク切れ検出ロジック追加
- `remark-tags`: コードブロック除外の明示的チェック追加
- テストランナー: 新規テストスイートの追加登録

**トレードオフ**:
- ✅ 最小限の変更で済む
- ✅ 既存パターンを活用
- ❌ プラグインの複雑化リスク
- ❌ 単一責任原則からの逸脱可能性

### Option B: 新規コンポーネントの作成

**対象**: テストインフラ（Req 5-8）

**新規作成**:
- `test/fixtures/` - テストフィクスチャディレクトリ
- `test/callout-test.js` - Callout専用単体テスト
- `test/integration/` - 統合テスト専用ディレクトリ
- `test/e2e/` - E2Eテスト（既存だが拡充）
- `test/combination-test.js` - 組み合わせテスト

**トレードオフ**:
- ✅ 明確な責任分離
- ✅ 独立したテスト実行が可能
- ❌ ファイル数増加
- ❌ テストランナー設定の更新が必要

### Option C: ハイブリッドアプローチ（推奨）

**Phase 1**: プラグイン改善
- 既存プラグインの軽微な改善
- リンク切れ検出はオプショナル機能として追加

**Phase 2**: テスト基盤整備
- `test/fixtures/`ディレクトリ新設
- 組み合わせテストマトリクス実装
- E2Eテストフレームワーク選定

**Phase 3**: 網羅的テスト実装
- 各プラグインの単体テスト拡充
- 統合テストの体系化
- ドキュメント更新

**トレードオフ**:
- ✅ 段階的な実装でリスク低減
- ✅ 各フェーズで成果を確認可能
- ❌ 計画の複雑さ

## 4. 複雑度・リスク評価

### 全体評価

| 項目 | 評価 |
|------|------|
| **工数** | M（3-7日） |
| **リスク** | Low |

### 根拠

- **工数M**: プラグイン自体は成熟しており大きな機能追加は不要。主な作業はテスト拡充
- **リスクLow**: 既存パターンの拡張が中心。新技術導入なし

### 要件別工数見積

| 要件 | 工数 | 備考 |
|------|------|------|
| Req 1-4 プラグイン改善 | S（1-2日） | 軽微な改善のみ |
| Req 5 単体テスト | S（1日） | Calloutテスト追加 |
| Req 6 統合テスト | M（2日） | 組み合わせマトリクス実装 |
| Req 7 E2Eテスト | M（2日） | ビルド出力検証の実装 |
| Req 8 テストドキュメント | S（1日） | フィクスチャ整理 |

## 5. 設計フェーズへの推奨事項

### 推奨アプローチ

**Option C（ハイブリッド）** を推奨

### 設計フェーズで決定すべき事項

1. **リンク切れ検出の実装方式**
   - ビルド時チェック vs ランタイムチェック
   - 存在確認のパフォーマンス考慮

2. **E2Eテストフレームワーク選定**
   - Playwright vs Puppeteer vs 軽量HTMLパーサー
   - Astroビルド出力の検証方法

3. **テストフィクスチャの構造**
   - 入力/期待出力のペア管理方式
   - JSONスキーマ vs Markdownファイル

### Research Needed（設計フェーズで調査）

- [ ] 複数行マークハイライトの現在の動作確認
- [ ] remark-tagsのコードブロック除外ロジック確認
- [ ] Astroビルド出力のプログラマティックな検証方法

## 6. まとめ

### 主要ギャップ

1. **プラグイン**: リンク切れ検出機能が未実装
2. **単体テスト**: Calloutの専用テストが不足
3. **統合テスト**: 組み合わせテストマトリクスの実装が必要
4. **E2Eテスト**: ビルド出力検証が未実装
5. **テストデータ**: 体系的なフィクスチャ管理が必要

### 強み

- 既存プラグインは機能的に成熟
- テスト基盤が存在（拡張可能）
- 処理順序とセキュリティ対策が適切に設計済み
